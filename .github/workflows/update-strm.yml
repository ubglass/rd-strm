name: RD STRM Builder + Koofr Sync + GitHub Pages (FINAL STREAM EDITION)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

permissions:
  contents: read
  pages: write
  id-token: write

jobs:

  build:
    runs-on: ubuntu-latest

    steps:

      # ----------------------------------------------------------
      # CHECKOUT REPO
      # ----------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # ----------------------------------------------------------
      # PREPARE site_root STRUCTURE
      # ----------------------------------------------------------
      - name: Prepare site_root
        run: |
          rm -rf site_root
          mkdir -p site_root/Movies
          mkdir -p site_root/TV_Shows

      # ----------------------------------------------------------
      # DISABLE JEKKYL FOR GITHUB PAGES
      # ----------------------------------------------------------
      - name: Disable Jekyll
        run: echo "theme: null" > site_root/_config.yml

      # ----------------------------------------------------------
      # ROOT INDEX PAGE
      # ----------------------------------------------------------
      - name: Root index
        run: |
          echo "<h1>RD STRM Library</h1>" > site_root/index.html
          echo "<ul>" >> site_root/index.html
          echo "<li><a href='Movies/'>Movies</a></li>" >> site_root/index.html
          echo "<li><a href='TV_Shows/'>TV Shows</a></li>" >> site_root/index.html
          echo "</ul>" >> site_root/index.html

      # ----------------------------------------------------------
      # FETCH REAL-DEBRID TORRENTS + DOWNLOADS (DIRECT CDN LINKS)
      # ----------------------------------------------------------
      - name: Fetch RD data
        run: |
          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
            "https://api.real-debrid.com/rest/1.0/torrents" > torrents.json

          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
            "https://api.real-debrid.com/rest/1.0/downloads" > downloads.json

      # ----------------------------------------------------------
      # BUILD STRM LIBRARY USING DIRECT CDN LINKS + TMDB METADATA
      # ----------------------------------------------------------
      - name: Build STRM library
        run: |
          set +e
          TMDB_KEY="${{ secrets.TMDB_API_KEY }}"
          CUTOFF=$(date -d "15 days ago" +%s)

          ####################################################################
          # FUNCTION: DIRECT CDN STREAM SELECTOR (NEWEST STREAMABLE == 1)
          ####################################################################
          get_direct_cdn_url() {
              FILE="$1"
              MATCHES=$(jq -c ".[] | select(.filename == \"$FILE\" and .streamable == 1)" downloads.json)

              if [ -z "$MATCHES" ]; then
                  echo ""
                  return
              fi

              echo "$MATCHES" | jq -s "sort_by(.generated) | last | .download"
          }

          ####################################################################
          # TMDB MOVIE DETAILS
          ####################################################################
          get_tmdb_movie_details() {
              QUERY="$1"
              SEARCH=$(curl -s \
                "https://api.themoviedb.org/3/search/movie?api_key=$TMDB_KEY&query=$QUERY")

              ID=$(echo "$SEARCH" | jq -r '.results[0].id')
              [ "$ID" = "null" ] && echo "" && return

              curl -s "https://api.themoviedb.org/3/movie/$ID?api_key=$TMDB_KEY"
          }

          ####################################################################
          # TMDB TV SHOW DETAILS
          ####################################################################
          get_tmdb_tv_details() {
              QUERY="$1"
              SEARCH=$(curl -s \
                "https://api.themoviedb.org/3/search/tv?api_key=$TMDB_KEY&query=$QUERY")

              ID=$(echo "$SEARCH" | jq -r '.results[0].id')
              [ "$ID" = "null" ] && echo "" && return

              curl -s "https://api.themoviedb.org/3/tv/$ID?api_key=$TMDB_KEY"
          }

          ####################################################################
          # TMDB EPISODE DETAILS
          ####################################################################
          get_tmdb_episode_details() {
              SID="$1"
              S="$2"
              E="$3"

              curl -s \
                "https://api.themoviedb.org/3/tv/$SID/season/$S/episode/$E?api_key=$TMDB_KEY"
          }

          ####################################################################
          # MAIN TORRENT PROCESSING LOOP
          ####################################################################
          jq -c '.[]?' torrents.json | while read TOR; do

              ID=$(echo "$TOR" | jq -r '.id')
              ADDED=$(echo "$TOR" | jq -r '.added')

              ADDED_EPOCH=$(date -d "$ADDED" +%s 2>/dev/null || echo 0)
              [ "$ADDED_EPOCH" -lt "$CUTOFF" ] && continue

              curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
                "https://api.real-debrid.com/rest/1.0/torrents/info/$ID" \
                > detail.json

              COUNT=$(jq '.files | length' detail.json)

              for i in $(seq 0 $(($COUNT - 1))); do

                  FILE=$(jq -r ".files[$i].path" detail.json)
                  BASENAME=$(basename "$FILE")
                  EXT="${BASENAME##*.}"

                  [[ ! "$EXT" =~ ^(mkv|mp4|avi|mov|webm)$ ]] && continue

                  ################################################################
                  # GET DIRECT CDN STREAM (PRIMARY)
                  ################################################################
                  DIRECT=$(get_direct_cdn_url "$BASENAME")

                  ################################################################
                  # FALLBACK â€” UNRESTRICT
                  ################################################################
                  if [ -z "$DIRECT" ] || [ "$DIRECT" = "null" ]; then
                      LINK=$(jq -r ".links[$i]?" detail.json)

                      UNR=$(curl -s -X POST \
                        -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
                        -d "link=$LINK" \
                        "https://api.real-debrid.com/rest/1.0/unrestrict/link")

                      DIRECT=$(echo "$UNR" | jq -r '.download')
                  fi

                  [ -z "$DIRECT" ] || [ "$DIRECT" = "null" ] && continue

                  ################################################################
                  # ------------------------- TV SHOWS ----------------------------
                  ################################################################
                  if [[ "$BASENAME" =~ [Ss][0-9][0-9][Ee][0-9][0-9] ]]; then

                      RAW_SHOW=$(echo "$BASENAME" | sed -E 's/\.[Ss][0-9]+.*//' | sed 's/[._]/ /g')
                      CLEAN_SHOW=$(echo "$RAW_SHOW" | sed -E 's/ +/ /g' | sed 's/ *$//')

                      YEAR=$(echo "$BASENAME" | grep -oE '(19[0-9]{2}|20[0-3][0-9])' | head -n1)

                      if [ -n "$YEAR" ]; then
                        SHOWDIR="site_root/TV_Shows/${CLEAN_SHOW} (${YEAR})"
                      else
                        SHOWDIR="site_root/TV_Shows/${CLEAN_SHOW}"
                      fi

                      mkdir -p "$SHOWDIR"

                      ################################################################
                      # TVSHOW NFO
                      ################################################################
                      if [ ! -f "$SHOWDIR/tvshow.nfo" ]; then

                          TVJSON=$(get_tmdb_tv_details "$CLEAN_SHOW")

                          SHOW_ID=$(echo "$TVJSON" | jq -r '.id')
                          PLOT=$(echo "$TVJSON" | jq -r '.overview // ""')
                          RUNTIME=$(echo "$TVJSON" | jq -r '.episode_run_time[0] // 0')

                          echo "$SHOW_ID" > "$SHOWDIR/.tmdb_id"

                          cat <<EOF > "$SHOWDIR/tvshow.nfo"
<tvshow>
  <title>$CLEAN_SHOW</title>
  <plot>$PLOT</plot>
  <runtime>$RUNTIME</runtime>
</tvshow>
EOF
                      else
                          SHOW_ID=$(cat "$SHOWDIR/.tmdb_id")
                      fi

                      ################################################################
                      # SEASON + EPISODE STRUCTURE
                      ################################################################
                      SNUM=$(echo "$BASENAME" | grep -oE '[Ss][0-9]+' | tr -d 'Ss')
                      ENUM=$(echo "$BASENAME" | grep -oE '[Ee][0-9]+' | tr -d 'Ee')

                      SNUM=$((10#$SNUM))
                      ENUM=$((10#$ENUM))

                      SEASON_DIR="$SHOWDIR/Season $(printf '%02d' $SNUM)"
                      mkdir -p "$SEASON_DIR"

                      STRM_PATH="$SEASON_DIR/${CLEAN_SHOW} S$(printf '%02d' $SNUM)E$(printf '%02d' $ENUM).strm"
                      echo "$DIRECT" > "$STRM_PATH"

                      ################################################################
                      # EPISODE NFO WITH PLOT + AIRED DATE
                      ################################################################
                      EPJSON=$(get_tmdb_episode_details "$SHOW_ID" "$SNUM" "$ENUM")

                      E_PLOT=$(echo "$EPJSON" | jq -r '.overview // ""')
                      E_AIRED=$(echo "$EPJSON" | jq -r '.air_date // ""')

                      NFO="$SEASON_DIR/${CLEAN_SHOW} S$(printf '%02d' $SNUM)E$(printf '%02d' $ENUM).nfo"

                      cat <<EOF > "$NFO"
<episodedetails>
  <title>$CLEAN_SHOW</title>
  <season>$SNUM</season>
  <episode>$ENUM</episode>
  <aired>$E_AIRED</aired>
  <plot>$E_PLOT</plot>
</episodedetails>
EOF

                      continue
                  fi

                  ################################################################
                  # --------------------------- MOVIES --------------------------
                  ################################################################
                  RAW=$(echo "$BASENAME" | sed -E 's/[._]/ /g')
                  YEAR=$(echo "$RAW" | grep -oE '(19[0-9]{2}|20[0-3][0-9])' | head -n1)
                  TITLE=$(echo "$RAW" | sed -E "s/$YEAR.*//" | sed -E 's/ +/ /g' | sed 's/ *$//')

                  MOVIEDIR="site_root/Movies/${TITLE} (${YEAR})"
                  mkdir -p "$MOVIEDIR"

                  STRMFILE="$MOVIEDIR/${TITLE} (${YEAR}).strm"
                  echo "$DIRECT" > "$STRMFILE"

                  ################################################################
                  # MOVIE NFO WITH PLOT + RUNTIME
                  ################################################################
                  MOVJSON=$(get_tmdb_movie_details "$TITLE")

                  M_PLOT=$(echo "$MOVJSON" | jq -r '.overview // ""')
                  M_RUNTIME=$(echo "$MOVJSON" | jq -r '.runtime // 0')

                  cat <<EOF > "$MOVIEDIR/movie.nfo"
<movie>
  <title>$TITLE</title>
  <year>$YEAR</year>
  <runtime>$M_RUNTIME</runtime>
  <plot>$M_PLOT</plot>
</movie>
EOF

              done
          done

      # ----------------------------------------------------------
      # CLEANUP OLD STRM FILES
      # ----------------------------------------------------------
      - name: Cleanup old STRM
        run: |
          find site_root -name "*.strm" -mtime +7 -delete
          find site_root -type d -empty -delete

      # ----------------------------------------------------------
      # BUILD HTML INDEXES
      # ----------------------------------------------------------
      - name: Build directory indexes
        run: |
          find site_root -type d | while read DIR; do
            HTML="$DIR/index.html"
            echo "<h2>$(basename "$DIR")</h2><ul>" > "$HTML"

            find "$DIR" -mindepth 1 -maxdepth 1 -type d | sort | while read SUB; do
              NAME=$(basename "$SUB")
              echo "<li><a href='$NAME/'>$NAME/</a></li>" >> "$HTML"
            done

            find "$DIR" -mindepth 1 -maxdepth 1 -type f | sort | while read FILE; do
              NAME=$(basename "$FILE")
              echo "<li><a href='$NAME'>$NAME</a></li>" >> "$HTML"
            done

            echo "</ul>" >> "$HTML"
          done

      # ----------------------------------------------------------
      # UPLOAD ARTIFACT FOR GITHUB PAGES
      # ----------------------------------------------------------
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site_root

      # ----------------------------------------------------------
      # KOFR FULL DELETE + UPLOAD
      # ----------------------------------------------------------
      - name: Delete rd-strm folder on Koofr
        run: |
          curl -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
            -X DELETE "${{ secrets.KOFR_URL }}" || true

          curl -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
            -X MKCOL "${{ secrets.KOFR_URL }}"

      - name: Upload to Koofr (safe encoded)
        run: |
          cd site_root

          encode() { echo "$1" | sed 's/ /%20/g'; }

          find . -type d | while read DIR; do
            CLEAN="${DIR#./}"
            URL="${{ secrets.KOFR_URL }}$(encode "$CLEAN")/"
            curl -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
              -X MKCOL "$URL" 2>/dev/null || true
          done

          find . -type f | while read FILE; do
            CLEAN="${FILE#./}"
            URL="${{ secrets.KOFR_URL }}$(encode "$CLEAN")"
            curl -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
              -T "$FILE" "$URL" >/dev/null 2>&1 || true
          done

  # ----------------------------------------------------------
  # DEPLOY TO GITHUB PAGES
  # ----------------------------------------------------------
  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
