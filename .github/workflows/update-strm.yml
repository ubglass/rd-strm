name: Build Real-Debrid STRM Library

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare folders
        run: |
          rm -rf strm
          mkdir -p strm/Movies
          mkdir -p "strm/TV Shows"

      - name: Fetch RD torrents
        run: |
          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
            "https://api.real-debrid.com/rest/1.0/torrents" \
            > torrents.json
          cat torrents.json

      - name: Convert RD torrents to STRM
        run: |
          jq -c '.[]' torrents.json | while read TORRENT; do
            ID=$(echo "$TORRENT" | jq -r '.id')
            NAME=$(echo "$TORRENT" | jq -r '.filename')

            echo "Processing torrent: $NAME"

            # Fetch detailed torrent info
            curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
              "https://api.real-debrid.com/rest/1.0/torrents/info/$ID" \
              > detail.json

            # Number of files
            COUNT=$(jq '.files | length' detail.json)

            # Skip if no files
            if [ "$COUNT" -eq 0 ]; then
              echo "No files in torrent, skipping."
              continue
            fi

            # Loop through each file by index
            for i in $(seq 0 $(($COUNT - 1))); do
              FILE=$(jq -r ".files[$i].path" detail.json)
              LINK=$(jq -r ".links[$i]?" detail.json)

              # Skip missing links
              if [ "$LINK" = "null" ] || [ -z "$LINK" ]; then
                echo "File has no RD link yet, skipping: $FILE"
                continue
              fi

              BASENAME=$(basename "$FILE")

              echo "â†’ File: $BASENAME"

              # TV Episode detection
              if [[ "$BASENAME" =~ S[0-9][0-9]E[0-9][0-9] ]]; then
                SHOW=$(echo "$BASENAME" | sed -E 's/\.[Ss][0-9]+[Ee][0-9]+.*//; s/[._]/ /g')
                SEASON=$(echo "$BASENAME" | grep -oE 'S[0-9]+' | tr -d S)
                EP=$(echo "$BASENAME" | grep -oE 'E[0-9]+' | tr -d E)

                mkdir -p "strm/TV Shows/$SHOW/Season $SEASON"
                echo "$LINK" > "strm/TV Shows/$SHOW/Season $SEASON/$SHOW S$(printf %02d $SEASON)E$(printf %02d $EP).strm"

              else
                # Movie parsing
                TITLE=$(echo "$BASENAME" | sed -E 's/\.[0-9]{4}\..*//; s/[._]/ /g')
                YEAR=$(echo "$BASENAME" | grep -oE '[0-9]{4}')
                [ -z "$YEAR" ] && YEAR=""

                echo "$LINK" > "strm/Movies/$TITLE ($YEAR).strm"
              fi

            done
          done

      - name: Upload STRM folder
        uses: actions/upload-pages-artifact@v3
        with:
          path: strm

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
      - uses: actions/deploy-pages@v4
