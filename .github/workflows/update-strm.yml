name: RD STRM Builder + Koofr Sync + GitHub Pages (FINAL FIXED)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

permissions:
  contents: read
  pages: write
  id-token: write

jobs:

  build:
    runs-on: ubuntu-latest

    steps:

      # ----------------------------------------------------------
      # CHECKOUT REPO
      # ----------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v4

      # ----------------------------------------------------------
      # PREPARE OUTPUT STRUCTURE
      # ----------------------------------------------------------
      - name: Prepare site_root
        run: |
          rm -rf site_root
          mkdir -p site_root/Movies
          mkdir -p site_root/TV_Shows

      # ----------------------------------------------------------
      # DISABLE JEKYLL FOR GITHUB PAGES
      # ----------------------------------------------------------
      - name: Disable Jekyll
        run: |
          echo "theme: null" > site_root/_config.yml

      # ----------------------------------------------------------
      # ROOT INDEX PAGE
      # ----------------------------------------------------------
      - name: Root index page
        run: |
          echo "<h1>RD STRM Library</h1>" > site_root/index.html
          echo "<ul>" >> site_root/index.html
          echo "<li><a href='Movies/'>Movies</a></li>" >> site_root/index.html
          echo "<li><a href='TV_Shows/'>TV Shows</a></li>" >> site_root/index.html
          echo "</ul>" >> site_root/index.html

      # ----------------------------------------------------------
      # FETCH RD TORRENTS
      # ----------------------------------------------------------
      - name: Fetch RD torrents
        run: |
          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
            "https://api.real-debrid.com/rest/1.0/torrents" \
            > torrents.json

      # ----------------------------------------------------------
      # BUILD STRM LIBRARY WITH METADATA + TMDB + CLEAN NAMES
      # ----------------------------------------------------------
      - name: Build STRM library
        run: |
          set +e
          TMDB_KEY="${{ secrets.TMDB_API_KEY }}"
          CUTOFF=$(date -d "15 days ago" +%s)

          ####################################################################
          # TMDB ARTWORK FETCHER (Optimized)
          ####################################################################
          fetch_artwork() {
            QUERY="$1"
            TYPE="$2"
            DEST="$3"

            # Skip if poster & fanart already exist
            if [ -f "$DEST/poster.jpg" ] && [ -f "$DEST/fanart.jpg" ]; then
              return
            fi

            RES=$(curl -s \
              "https://api.themoviedb.org/3/search/$TYPE?api_key=$TMDB_KEY&query=$QUERY")

            ID=$(echo "$RES" | jq -r '.results[0].id')
            [ "$ID" = "null" ] && return

            DETAILS=$(curl -s \
              "https://api.themoviedb.org/3/$TYPE/$ID?api_key=$TMDB_KEY")

            POSTER_PATH=$(echo "$DETAILS" | jq -r '.poster_path')
            FANART_PATH=$(echo "$DETAILS" | jq -r '.backdrop_path')

            # poster
            if [ ! -f "$DEST/poster.jpg" ] && [ "$POSTER_PATH" != "null" ]; then
              curl -s "https://image.tmdb.org/t/p/original$POSTER_PATH" \
                -o "$DEST/poster.jpg"
            fi

            # fanart
            if [ ! -f "$DEST/fanart.jpg" ] && [ "$FANART_PATH" != "null" ]; then
              curl -s "https://image.tmdb.org/t/p/original$FANART_PATH" \
                -o "$DEST/fanart.jpg"
            fi
          }

          ####################################################################
          # PARSE TORRENT FILES & GENERATE STRM + NFO
          ####################################################################
          jq -c '.[]?' torrents.json | while read TOR; do

            ID=$(echo "$TOR" | jq -r '.id')
            ADDED=$(echo "$TOR" | jq -r '.added')

            ADDED_EPOCH=$(date -d "$ADDED" +%s 2>/dev/null || echo 0)
            [ "$ADDED_EPOCH" -lt "$CUTOFF" ] && continue

            curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
              "https://api.real-debrid.com/rest/1.0/torrents/info/$ID" \
              > detail.json

            COUNT=$(jq '.files | length' detail.json)

            for i in $(seq 0 $(($COUNT - 1))); do

              FILE=$(jq -r ".files[$i].path" detail.json)
              LINK=$(jq -r ".links[$i]?" detail.json)
              BASENAME=$(basename "$FILE")
              EXT="${BASENAME##*.}"

              [[ ! "$EXT" =~ ^(mkv|mp4|avi|mov|webm)$ ]] && continue

              ################################################################
              # TV SHOW LOGIC
              ################################################################
              if [[ "$BASENAME" =~ [Ss][0-9][0-9][Ee][0-9][0-9] ]]; then

                RAW_SHOW=$(echo "$BASENAME" | sed -E 's/\.[Ss][0-9]+.*//' | sed 's/[._]/ /g')
                CLEAN_SHOW=$(echo "$RAW_SHOW" | sed -E 's/ +/ /g' | sed 's/ *$//')

                YEAR=$(echo "$BASENAME" \
                  | grep -oE '(19[0-9]{2}|20[0-3][0-9])' \
                  | head -n1)

                if [ -n "$YEAR" ]; then
                  SHOWDIR="site_root/TV_Shows/${CLEAN_SHOW} (${YEAR})"
                else
                  SHOWDIR="site_root/TV_Shows/${CLEAN_SHOW}"
                fi

                mkdir -p "$SHOWDIR"

                fetch_artwork "$CLEAN_SHOW" "tv" "$SHOWDIR"

                if [ ! -f "$SHOWDIR/tvshow.nfo" ]; then
                  echo "<tvshow>" > "$SHOWDIR/tvshow.nfo"
                  echo "  <title>$CLEAN_SHOW</title>" >> "$SHOWDIR/tvshow.nfo"
                  [ -n "$YEAR" ] && echo "  <year>$YEAR</year>" >> "$SHOWDIR/tvshow.nfo"
                  echo "</tvshow>" >> "$SHOWDIR/tvshow.nfo"
                fi

                SNUM=$(echo "$BASENAME" | grep -oE '[Ss][0-9]+' | tr -d 'Ss')
                ENUM=$(echo "$BASENAME" | grep -oE '[Ee][0-9]+' | tr -d 'Ee')

                SNUM=$((10#$SNUM))
                ENUM=$((10#$ENUM))

                SEASON_DIR="$SHOWDIR/Season $(printf '%02d' $SNUM)"
                mkdir -p "$SEASON_DIR"

                OUTFILE="$SEASON_DIR/${CLEAN_SHOW} S$(printf '%02d' $SNUM)E$(printf '%02d' $ENUM).strm"

                if [ -f "$OUTFILE" ]; then
                  continue
                fi

                DIRECT="$LINK"
                if [ -z "$DIRECT" ] || [ "$DIRECT" = "null" ]; then
                  UNR=$(curl -s -X POST \
                    -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
                    -d "link=$LINK" \
                    "https://api.real-debrid.com/rest/1.0/unrestrict/link")
                  DIRECT=$(echo "$UNR" | jq -r '.download')
                fi

                echo "$DIRECT" > "$OUTFILE"

                EP_NFO="$SEASON_DIR/${CLEAN_SHOW} S$(printf '%02d' $SNUM)E$(printf '%02d' $ENUM).nfo"
                echo "<episodedetails>" > "$EP_NFO"
                echo "  <title>$CLEAN_SHOW S$(printf '%02d' $SNUM)E$(printf '%02d' $ENUM)</title>" >> "$EP_NFO"
                echo "  <season>$SNUM</season>" >> "$EP_NFO"
                echo "  <episode>$ENUM</episode>" >> "$EP_NFO"
                [ -n "$YEAR" ] && echo "  <year>$YEAR</year>" >> "$EP_NFO"
                echo "</episodedetails>" >> "$EP_NFO"

                continue
              fi

              ################################################################
              # MOVIE LOGIC
              ################################################################
              RAW_TITLE=$(echo "$BASENAME" | sed -E 's/[._]/ /g')
              YEAR=$(echo "$BASENAME" \
                | grep -oE '(19[0-9]{2}|20[0-3][0-9])' \
                | head -n1)

              TITLE_NO_EXTRA=$(echo "$RAW_TITLE" | sed -E "s/$YEAR.*//")
              CLEAN_TITLE=$(echo "$TITLE_NO_EXTRA" \
                | sed -E 's/ +/ /g' | sed 's/ *$//')

              MOVIEDIR="site_root/Movies/${CLEAN_TITLE} (${YEAR})"
              mkdir -p "$MOVIEDIR"

              fetch_artwork "$CLEAN_TITLE" "movie" "$MOVIEDIR"

              OUTFILE="$MOVIEDIR/${CLEAN_TITLE} (${YEAR}).strm"

              if [ -f "$OUTFILE" ]; then
                continue
              fi

              DIRECT="$LINK"
              if [ -z "$DIRECT" ] || [ "$DIRECT" = "null" ]; then
                UNR=$(curl -s -X POST \
                  -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
                  -d "link=$LINK" \
                  "https://api.real-debrid.com/rest/1.0/unrestrict/link")
                DIRECT=$(echo "$UNR" | jq -r '.download')
              fi

              echo "$DIRECT" > "$OUTFILE"

              echo "<movie>" > "$MOVIEDIR/movie.nfo"
              echo "  <title>$CLEAN_TITLE</title>" >> "$MOVIEDIR/movie.nfo"
              echo "  <year>$YEAR</year>" >> "$MOVIEDIR/movie.nfo"
              echo "</movie>" >> "$MOVIEDIR/movie.nfo"

            done
          done

      # ----------------------------------------------------------
      # DELETE OLD STRM FILES LOCALLY (7 DAYS)
      # ----------------------------------------------------------
      - name: Cleanup old STRM
        run: |
          find site_root -name "*.strm" -mtime +7 -delete
          find site_root -type d -empty -delete

      # ----------------------------------------------------------
      # BUILD HTML INDEXES
      # ----------------------------------------------------------
      - name: Build directory indexes
        run: |
          find site_root -type d | while read DIR; do
            HTML="$DIR/index.html"
            echo "<h2>$(basename "$DIR")</h2>" > "$HTML"
            echo "<ul>" >> "$HTML"

            find "$DIR" -mindepth 1 -maxdepth 1 -type d | sort | while read SUB; do
              NAME=$(basename "$SUB")
              echo "<li><a href='$NAME/'>$NAME/</a></li>" >> "$HTML"
            done

            find "$DIR" -mindepth 1 -maxdepth 1 -type f | sort | while read FILE; do
              NAME=$(basename "$FILE")
              echo "<li><a href='$NAME'>$NAME</a></li>" >> "$HTML"
            done

            echo "</ul>" >> "$HTML"
          done

      # ----------------------------------------------------------
      # UPLOAD ARTIFACT TO GITHUB ACTIONS
      # ----------------------------------------------------------
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site_root

      # ----------------------------------------------------------
      # KOFR FULL SYNC â€” DELETE + CLEAN UPLOAD
      # ----------------------------------------------------------
      - name: FULL DELETE rd-strm folder on Koofr
        run: |
          curl -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
            -X DELETE "${{ secrets.KOFR_URL }}" || true

          curl -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
            -X MKCOL "${{ secrets.KOFR_URL }}"

      - name: Upload library to Koofr (SAFE URL-ENCODING)
        run: |
          cd site_root

          encode() {
            echo "$1" | sed 's/ /%20/g'
          }

          # Create directories
          find . -type d | while read DIR; do
            CLEAN="${DIR#./}"
            URL="${{ secrets.KOFR_URL }}$(encode "$CLEAN")/"
            curl -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
              -X MKCOL "$URL" 2>/dev/null || true
          done

          # Upload files
          find . -type f | while read FILE; do
            CLEAN="${FILE#./}"
            URL="${{ secrets.KOFR_URL }}$(encode "$CLEAN")"

            curl -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
              -T "$FILE" "$URL"
          done

  # ----------------------------------------------------------
  # DEPLOY TO GITHUB PAGES
  # ----------------------------------------------------------
  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
