name: RD STRM DEBUG BUILDER

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare
        run: |
          echo "==== PREPARE ===="
          rm -rf site_root
          mkdir -p site_root/Movies site_root/TV_Shows
          echo "Prepared workspace."

      - name: Fetch RD downloads
        run: |
          echo "==== FETCH RD DOWNLOADS ===="
          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
            "https://api.real-debrid.com/rest/1.0/downloads" \
            > downloads.json

          echo "[DEBUG] RAW RD DOWNLOAD JSON:"
          cat downloads.json | sed 's/^/    /'

      - name: Build Library
        run: |
          set +e
          echo "==== BUILD LIBRARY (FULL DEBUG) ===="

          TMDB="${{ secrets.TMDB_API_KEY }}"

          urlencode() { jq -nr --arg v "$1" '$v|@uri'; }
          escape() { echo "$1" | sed 's/%/%%/g'; }
          safe() { echo "$1" | sed 's#[^-_.a-zA-Z0-9 ()]#_#g'; }

          CUTOFF=$(date -d "15 days ago" +%s)
          echo "[DEBUG] CUTOFF timestamp: $CUTOFF"

          declare -A EP_MAP
          declare -A EP_META
          declare -A MOV_MAP
          declare -A MOV_META

          echo "==== START LOOP OVER RD DOWNLOADS ===="

          jq -c 'if type=="array" then .[] else . end' downloads.json |
          while read -r DL; do
            echo ""
            echo "--------------------------------------------------------"
            echo "[DEBUG] PROCESSING ENTRY:"
            echo "$DL" | sed 's/^/   /'
            echo "--------------------------------------------------------"

            FILE=$(echo "$DL" | jq -r '.filename // ""')
            LINK=$(echo "$DL" | jq -r '.download // ""')
            STREAM=$(echo "$DL" | jq -r '.streamable // 0')
            GEN=$(echo "$DL" | jq -r '.generated // ""')

            echo "[DEBUG] FILE=$FILE"
            echo "[DEBUG] LINK=$LINK"
            echo "[DEBUG] STREAMABLE=$STREAM"
            echo "[DEBUG] GENERATED=$GEN"

            TS=$(date -d "$GEN" +%s 2>/dev/null || echo 0)
            echo "[DEBUG] TS=$TS"

            [ "$STREAM" != "1" ] && echo "[SKIP] Not streamable." && continue
            [ "$TS" -lt "$CUTOFF" ] && echo "[SKIP] Too old." && continue

            BASE=$(basename "$FILE")
            EXT="${BASE##*.}"
            NAME="${BASE%.*}"

            echo "[DEBUG] BASE=$BASE EXT=$EXT NAME=$NAME"

            if ! [[ "$EXT" =~ ^(mkv|mp4|webm|avi|mov)$ ]]; then
              echo "[SKIP] Unsupported extension."
              continue
            fi

            # ======================================
            # TV DETECTION
            # ======================================
            echo "[DEBUG] Checking TV pattern…"

            if [[ "$NAME" =~ [Ss][0-9]{1,2}[Ee][0-9]{1,2} ]]; then
              echo "[DEBUG] TV Match detected."

              S=$(echo "$NAME" | grep -oEi "S[0-9]{1,2}" | tr -d 'S')
              E=$(echo "$NAME" | grep -oEi "E[0-9]{1,2}" | tr -d 'E')
              S=$((10#$S)); E=$((10#$E))

              echo "[DEBUG] Parsed S=$S E=$E"

              RAW=$(echo "$NAME" |
                  sed -E 's/[_\.]/ /g' |
                  sed -E 's/[Ss][0-9]{1,2}[Ee][0-9]{1,2}.*//' |
                  sed 's/  */ /g' | sed 's/ $//')

              echo "[DEBUG] RAWTV TITLE='$RAW'"

              YEAR=$(echo "$RAW" | grep -oE '(19[0-9]{2}|20[0-3][0-9])')
              echo "[DEBUG] YEAR='$YEAR'"

              SEARCH_TITLE="$RAW"
              if [ -n "$YEAR" ]; then
                SEARCH_TITLE=$(echo "$RAW" | sed -E "s/$YEAR//" | sed 's/  */ /g')
              fi

              echo "[DEBUG] CLEANED TV TITLE='$SEARCH_TITLE'"

              ENC=$(urlencode "$SEARCH_TITLE")

              echo "[DEBUG] TMDB Search Query: $SEARCH_TITLE / Year=$YEAR"

              if [ -n "$YEAR" ]; then
                SEARCH=$(curl -s "https://api.themoviedb.org/3/search/tv?api_key=$TMDB&query=$ENC&first_air_date_year=$YEAR")
              else
                SEARCH=$(curl -s "https://api.themoviedb.org/3/search/tv?api_key=$TMDB&query=$ENC")
              fi

              echo "[DEBUG] TMDB TV SEARCH RESPONSE:"
              echo "$SEARCH" | sed 's/^/   /'

              TID=$(echo "$SEARCH" | jq -r '.results[0].id // empty')
              echo "[DEBUG] TID='$TID'"

              if [ -z "$TID" ]; then
                echo "[SKIP] TV TMDB match failed."
                continue
              fi

              TNAME=$(echo "$SEARCH" | jq -r '.results[0].name')
              TYEAR=$(echo "$SEARCH" | jq -r '.results[0].first_air_date' | cut -c1-4)

              echo "[DEBUG] TMDB MATCHED: $TNAME ($TYEAR)"

              KEY="tv_${TID}_S${S}_E${E}"
              EP_MAP[$KEY]="$LINK"
              EP_META[$KEY]="$TID|$TNAME|$TYEAR|$S|$E|$TS"
              echo "[OK] TV episode added: KEY=$KEY"

              continue
            fi

            # ======================================
            # MOVIE DETECTION
            # ======================================
            echo "[DEBUG] Checking movie pattern…"

            RAW=$(echo "$NAME" |
              sed -E 's/[_\.]/ /g' |
              sed 's/  */ /g' | sed 's/ $//')

            echo "[DEBUG] RAW MOVIE='$RAW'"

            YEAR=$(echo "$RAW" | grep -oE '(19[0-9]{2}|20[0-3][0-9])')
            echo "[DEBUG] YEAR='$YEAR'"

            if [ -n "$YEAR" ]; then
              CLEAN=$(echo "$RAW" | sed -E "s/$YEAR.*//")
            else
              CLEAN="$RAW"
            fi

            echo "[DEBUG] CLEAN MOVIE TITLE='$CLEAN'"

            ENC=$(urlencode "$CLEAN")

            if [ -n "$YEAR" ]; then
              SEARCH=$(curl -s "https://api.themoviedb.org/3/search/movie?api_key=$TMDB&query=$ENC&year=$YEAR")
            else
              SEARCH=$(curl -s "https://api.themoviedb.org/3/search/movie?api_key=$TMDB&query=$ENC")
            fi

            echo "[DEBUG] TMDB MOVIE SEARCH RESPONSE:"
            echo "$SEARCH" | sed 's/^/   /'

            MID=$(echo "$SEARCH" | jq -r '.results[0].id // empty')
            echo "[DEBUG] MID='$MID'"

            if [ -z "$MID" ]; then
              echo "[SKIP] Not a movie."
              continue
            fi

            MNAME=$(echo "$SEARCH" | jq -r '.results[0].title')
            MYEAR=$(echo "$SEARCH" | jq -r '.results[0].release_date' | cut -c1-4)

            KEY="movie_${MID}"
            MOV_MAP[$KEY]="$LINK"
            MOV_META[$KEY]="$MID|$MNAME|$MYEAR|$TS"

            echo "[OK] MOVIE added: $MNAME ($MYEAR)"

          done

          echo ""
          echo "==== SUMMARY ===="
          echo "TV EP ENTRIES: ${#EP_MAP[@]}"
          echo "MOVIES: ${#MOV_MAP[@]}"
          echo "=================="

      - name: Upload tree
        run: |
          echo "==== OUTPUT TREE ===="
          tree site_root || true

