name: RD STRM Builder + Koofr Sync + GitHub Pages

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

permissions:
  contents: read
  pages: write
  id-token: write

jobs:

  build:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare site_root
        run: |
          rm -rf site_root
          mkdir -p site_root/Movies
          mkdir -p site_root/TV_Shows

      - name: Disable Jekyll
        run: echo "theme: null" > site_root/_config.yml

      - name: Create root index
        run: |
          printf "<h1>RD STRM Library</h1>\n<ul>\n<li><a href='Movies/'>Movies</a></li>\n<li><a href='TV_Shows/'>TV Shows</a></li>\n</ul>" > site_root/index.html

      - name: Fetch Real-Debrid Data
        run: |
          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" "https://api.real-debrid.com/rest/1.0/torrents" > torrents.json
          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" "https://api.real-debrid.com/rest/1.0/downloads" > downloads.json

      - name: Build STRM library
        run: |
          TMDB="${{ secrets.TMDB_API_KEY }}"
          CUTOFF=$(date -d "15 days ago" +%s)

          # Clean URL (no quotes, no spaces)
          clean_url() {
            echo "$1" | tr -d '"' | tr -d "'" | sed 's/[[:space:]]*$//'
          }

          # Episode-based matching using strict SxxEyy pattern
          get_direct_cdn_episode() {
            PATTERN="$1"
            jq -c ".[] | select(.filename | test(\"$PATTERN\"; \"i\"))" downloads.json \
              | jq -s "sort_by(.generated) | last | .download"
          }

          # Movie filename exact match
          get_direct_cdn_movie() {
            FILE="$1"
            jq -c ".[] | select(.filename == \"$FILE\")" downloads.json \
              | jq -s "sort_by(.generated) | last | .download"
          }

          jq -c '.[]?' torrents.json | while read TOR; do

            ID=$(echo "$TOR" | jq -r '.id')
            ADDED_EPOCH=$(date -d "$(echo "$TOR" | jq -r '.added')" +%s 2>/dev/null || echo 0)
            [ "$ADDED_EPOCH" -lt "$CUTOFF" ] && continue

            curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" "https://api.real-debrid.com/rest/1.0/torrents/info/$ID" > detail.json
            COUNT=$(jq '.files | length' detail.json)

            for i in $(seq 0 $((COUNT - 1))); do

              FILE=$(jq -r ".files[$i].path" detail.json)
              BASENAME=$(basename "$FILE")
              EXT="${BASENAME##*.}"
              [[ ! "$EXT" =~ ^(mkv|mp4|avi|mov|webm)$ ]] && continue

              ################################################################
              # --------------------------- TV SHOWS --------------------------
              ################################################################
              if [[ "$BASENAME" =~ [Ss][0-9]{2}[Ee][0-9]{2} ]]; then

                RAW=$(echo "$BASENAME" | sed -E 's/\.[Ss][0-9]+.*//' | sed 's/[._]/ /g' | sed 's/  */ /g')
                YEAR=$(echo "$BASENAME" | grep -oE '(19[0-9]{2}|20[0-3][0-9])')

                # Episode extraction
                SNUM=$(echo "$BASENAME" | grep -oE 'S[0-9]{2}' | tr -d 'S')
                ENUM=$(echo "$BASENAME" | grep -oE 'E[0-9]{2}' | tr -d 'E')
                SFX=$(printf "%02d" "$SNUM")
                EFX=$(printf "%02d" "$ENUM")

                PATTERN="S${SFX}E${EFX}"

                ################################################################
                # STRICT DIRECT MATCH: SxxEyy only
                ################################################################
                DIRECT=$(get_direct_cdn_episode "$PATTERN")

                # Fallback unrestrict
                if [ -z "$DIRECT" ] || [ "$DIRECT" = "null" ]; then
                  LINK=$(jq -r ".links[$i]" detail.json)

                  UNR=$(curl -s -X POST \
                    -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
                    -d "link=$LINK" \
                    "https://api.real-debrid.com/rest/1.0/unrestrict/link")

                  DIRECT=$(echo "$UNR" | jq -r '.download')
                fi

                [ -z "$DIRECT" ] || [ "$DIRECT" = "null" ] && continue
                DIRECT=$(clean_url "$DIRECT")

                # Show directory
                if [ -n "$YEAR" ]; then
                  SHOWDIR="site_root/TV_Shows/${RAW} (${YEAR})"
                else
                  SHOWDIR="site_root/TV_Shows/${RAW}"
                fi
                mkdir -p "$SHOWDIR"

                ################################################################
                # tvshow.nfo creation
                ################################################################
                if [ ! -f "$SHOWDIR/.tmdb_id" ]; then

                  SEARCH=$(curl -s "https://api.themoviedb.org/3/search/tv?api_key=$TMDB&query=$RAW")
                  SID=$(echo "$SEARCH" | jq -r '.results[0].id')
                  echo "$SID" > "$SHOWDIR/.tmdb_id"

                  DETAIL=$(curl -s "https://api.themoviedb.org/3/tv/$SID?api_key=$TMDB")

                  printf "<tvshow>\n<title>%s</title>\n<plot>%s</plot>\n<runtime>%s</runtime>\n</tvshow>" \
                    "$RAW" \
                    "$(echo "$DETAIL" | jq -r '.overview // ""')" \
                    "$(echo "$DETAIL" | jq -r '.episode_run_time[0] // 0')" \
                    > "$SHOWDIR/tvshow.nfo"
                fi

                SID=$(cat "$SHOWDIR/.tmdb_id")

                ################################################################
                # Episode-level metadata
                ################################################################
                SEASON_DIR="$SHOWDIR/Season $SFX"
                mkdir -p "$SEASON_DIR"

                STRM="$SEASON_DIR/${RAW} S${SFX}E${EFX}.strm"
                printf "%s" "$DIRECT" > "$STRM"

                EPJSON=$(curl -s "https://api.themoviedb.org/3/tv/$SID/season/$SNUM/episode/$ENUM?api_key=$TMDB")

                printf "<episodedetails>\n<title>%s</title>\n<season>%s</season>\n<episode>%s</episode>\n<aired>%s</aired>\n<plot>%s</plot>\n</episodedetails>" \
                  "$RAW" "$SNUM" "$ENUM" \
                  "$(echo "$EPJSON" | jq -r '.air_date // ""')" \
                  "$(echo "$EPJSON" | jq -r '.overview // ""')" \
                  > "$SEASON_DIR/${RAW} S${SFX}E${EFX}.nfo"

                continue
              fi

              ################################################################
              # ------------------------------ MOVIES -------------------------
              ################################################################
              RAW2=$(echo "$BASENAME" | sed -E 's/[._]/ /g')
              YEAR=$(echo "$RAW2" | grep -oE '(19[0-9]{2}|20[0-3][0-9])')
              TITLE=$(echo "$RAW2" | sed -E "s/$YEAR.*//" | sed 's/  */ /g')

              DIRECT=$(get_direct_cdn_movie "$BASENAME")

              if [ -z "$DIRECT" ] || [ "$DIRECT" = "null" ]; then
                LINK=$(jq -r ".links[$i]" detail.json)
                UNR=$(curl -s -X POST \
                    -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
                    -d "link=$LINK" \
                    "https://api.real-debrid.com/rest/1.0/unrestrict/link")
                DIRECT=$(echo "$UNR" | jq -r '.download')
              fi

              [ -z "$DIRECT" ] || [ "$DIRECT" = "null" ] && continue
              DIRECT=$(clean_url "$DIRECT")

              MOVIEDIR="site_root/Movies/${TITLE} (${YEAR})"
              mkdir -p "$MOVIEDIR"

              printf "%s" "$DIRECT" > "$MOVIEDIR/${TITLE} (${YEAR}).strm"

              MSEARCH=$(curl -s "https://api.themoviedb.org/3/search/movie?api_key=$TMDB&query=$TITLE")
              MID=$(echo "$MSEARCH" | jq -r '.results[0].id')

              MDET=$(curl -s "https://api.themoviedb.org/3/movie/$MID?api_key=$TMDB")

              printf "<movie>\n<title>%s</title>\n<year>%s</year>\n<runtime>%s</runtime>\n<plot>%s</plot>\n</movie>" \
                "$TITLE" "$YEAR" \
                "$(echo "$MDET" | jq -r '.runtime // 0')" \
                "$(echo "$MDET" | jq -r '.overview // ""')" \
                > "$MOVIEDIR/movie.nfo"

            done
          done

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: site_root

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
