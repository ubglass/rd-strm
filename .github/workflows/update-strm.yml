name: RD STRM Builder (Final Stable With Episode NFO)

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare workspace
        run: |
          echo "== PREPARE =="
          rm -rf site_root
          mkdir -p site_root/Movies site_root/TV_Shows
          echo "[OK] Workspace prepared."

      - name: Fetch RD downloads
        run: |
          echo "== FETCH REAL-DEBRID DOWNLOADS =="
          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
            "https://api.real-debrid.com/rest/1.0/downloads" \
            > downloads.json

          echo "[DEBUG] RD JSON:"
          sed 's/^/  /' downloads.json

      - name: Build STRM Library
        run: |
          set +e
          echo "== BUILDING LIBRARY =="

          TMDB="${{ secrets.TMDB_API_KEY }}"

          urlencode() { jq -nr --arg v "$1" '$v|@uri'; }
          escape() { echo "$1" | sed 's/%/%%/g'; }
          safe() { echo "$1" | sed 's#[^-_.a-zA-Z0-9 ()]#_#g'; }

          CUTOFF=$(date -d "15 days ago" +%s)
          echo "[DEBUG] CUTOFF = $CUTOFF"

          declare -A EP_MAP
          declare -A EP_META
          declare -A MOV_MAP
          declare -A MOV_META

          echo "== PARSING DOWNLOADS =="

          # SAFE LOOP (no subshell)
          while read -r DL; do
            echo ""
            echo "------------- ENTRY -------------"
            echo "$DL" | sed 's/^/   /'

            FILE=$(echo "$DL" | jq -r '.filename // ""')
            LINK=$(echo "$DL" | jq -r '.download // ""')
            STREAM=$(echo "$DL" | jq -r '.streamable // 0')
            GEN=$(echo "$DL" | jq -r '.generated // ""')

            echo "[DEBUG] FILE=$FILE"
            echo "[DEBUG] LINK=$LINK"
            echo "[DEBUG] STREAM=$STREAM"
            echo "[DEBUG] GEN=$GEN"

            # Robust timestamp parsing
            TS=$(echo "$GEN" | sed 's/\..*Z//; s/T/ /' | \
              xargs -I{} date -d "{}" +%s 2>/dev/null || echo 0)

            echo "[DEBUG] TS=$TS"

            [ "$STREAM" != "1" ] && echo "[SKIP] Not streamable." && continue
            [ "$TS" -lt "$CUTOFF" ] && echo "[SKIP] Too old." && continue

            BASE=$(basename "$FILE")
            EXT="${BASE##*.}"
            NAME="${BASE%.*}"

            [[ ! "$EXT" =~ ^(mkv|mp4|avi|mov|webm)$ ]] && echo "[SKIP] Unsupported extension." && continue

            ########################################################
            # TV DETECTION
            ########################################################
            if [[ "$NAME" =~ [Ss][0-9]{1,2}[Ee][0-9]{1,2} ]]; then
              echo "[DEBUG] TV detected."

              S=$(echo "$NAME" | grep -oEi "S[0-9]{1,2}" | tr -d 'S')
              E=$(echo "$NAME" | grep -oEi "E[0-9]{1,2}" | tr -d 'E')

              S=$((10#$S))
              E=$((10#$E))

              RAW=$(echo "$NAME" |
                sed -E 's/[_\.]/ /g' |
                sed -E 's/[Ss][0-9]{1,2}[Ee][0-9]{1,2}.*//' |
                sed 's/  */ /g; s/ $//')

              YEAR=$(echo "$RAW" | grep -oE '(19[0-9]{2}|20[0-3][0-9])')

              if [ -n "$YEAR" ]; then
                SEARCH_TITLE=$(echo "$RAW" | sed -E "s/$YEAR//" | sed 's/  */ /g')
              else
                SEARCH_TITLE="$RAW"
              fi

              ENC=$(urlencode "$SEARCH_TITLE")

              if [ -n "$YEAR" ]; then
                SEARCH=$(curl -s \
                  "https://api.themoviedb.org/3/search/tv?api_key=$TMDB&query=$ENC&first_air_date_year=$YEAR")
              else
                SEARCH=$(curl -s \
                  "https://api.themoviedb.org/3/search/tv?api_key=$TMDB&query=$ENC")
              fi

              TID=$(echo "$SEARCH" | jq -r '.results[0].id // empty')
              [ -z "$TID" ] && echo "[SKIP] No TV match." && continue

              TNAME=$(echo "$SEARCH" | jq -r '.results[0].name')
              TYEAR=$(echo "$SEARCH" | jq -r '.results[0].first_air_date' | cut -c1-4)

              KEY="tv_${TID}_S${S}_E${E}"
              EP_MAP[$KEY]="$LINK"
              EP_META[$KEY]="$TID|$TNAME|$TYEAR|$S|$E|$TS"
              continue
            fi

            ########################################################
            # MOVIE DETECTION
            ########################################################
            RAW=$(echo "$NAME" |
              sed -E 's/[_\.]/ /g' |
              sed 's/  */ /g; s/ $//')

            YEAR=$(echo "$RAW" | grep -oE '(19[0-9]{2}|20[0-3][0-9])')

            if [ -n "$YEAR" ]; then
              CLEAN=$(echo "$RAW" | sed -E "s/$YEAR.*//")
            else
              CLEAN="$RAW"
            fi

            CLEAN=$(echo "$CLEAN" | sed 's/  */ /g; s/ $//')
            ENC=$(urlencode "$CLEAN")

            if [ -n "$YEAR" ]; then
              SEARCH=$(curl -s \
                "https://api.themoviedb.org/3/search/movie?api_key=$TMDB&query=$ENC&year=$YEAR")
            else
              SEARCH=$(curl -s \
                "https://api.themoviedb.org/3/search/movie?api_key=$TMDB&query=$ENC")
            fi

            MID=$(echo "$SEARCH" | jq -r '.results[0].id // empty')
            [ -z "$MID" ] && echo "[SKIP] No movie match." && continue

            MNAME=$(echo "$SEARCH" | jq -r '.results[0].title')
            MYEAR=$(echo "$SEARCH" | jq -r '.results[0].release_date' | cut -c1-4)

            KEY="movie_${MID}"
            MOV_MAP[$KEY]="$LINK"
            MOV_META[$KEY]="$MID|$MNAME|$MYEAR|$TS"

          done < <(jq -c 'if type=="array" then .[] else . end' downloads.json)

          echo ""
          echo "=== SUMMARY ==="
          echo "TV EPISODES: ${#EP_MAP[@]}"
          echo "MOVIES: ${#MOV_MAP[@]}"
          echo "================"

          ########################################################
          # BUILD TV OUTPUT + EPISODE NFO
          ########################################################
          echo "== BUILDING TV SHOWS =="

          for KEY in "${!EP_MAP[@]}"; do
            META="${EP_META[$KEY]}"
            IFS='|' read TID TNAME TYEAR S E TS <<< "$META"

            SHOW=$(safe "$TNAME")
            SHOWDIR="site_root/TV_Shows/${SHOW} (${TYEAR})"
            mkdir -p "$SHOWDIR"

            # tvshow.nfo
            if [ ! -f "$SHOWDIR/tvshow.nfo" ]; then
              DET=$(curl -s "https://api.themoviedb.org/3/tv/$TID?api_key=$TMDB")
              PLOT=$(echo "$DET" | jq -r '.overview // ""')
              RUNTIME=$(echo "$DET" | jq -r '.episode_run_time[0] // 0')

              printf "<tvshow><title>%s</title><plot>%s</plot><runtime>%s</runtime></tvshow>" \
                "$(escape "$TNAME")" "$(escape "$PLOT")" "$RUNTIME" \
                > "$SHOWDIR/tvshow.nfo"
            fi

            # Season folder
            SNAME="Season $(printf '%02d' "$S")"
            SD="$SHOWDIR/$SNAME"
            mkdir -p "$SD"

            # STRM
            STRM="$SD/${SHOW} (${TYEAR}) - S$(printf '%02d' "$S")E$(printf '%02d' "$E").strm"
            echo "${EP_MAP[$KEY]}" > "$STRM"

            # EPISODE DETAILS FROM TMDB
            EDET=$(curl -s "https://api.themoviedb.org/3/tv/$TID/season/$S/episode/$E?api_key=$TMDB")

            ETITLE=$(echo "$EDET" | jq -r '.name // ""')
            EPLOT=$(echo "$EDET" | jq -r '.overview // ""')
            ERUNTIME=$(echo "$EDET" | jq -r '.runtime // 0')
            EAIR=$(echo "$EDET" | jq -r '.air_date // ""')
            EID=$(echo "$EDET" | jq -r '.id // ""')

            NFO_FILE="$SD/S$(printf '%02d' "$S")E$(printf '%02d' "$E").nfo"

            printf "<episodedetails>
              <title>%s</title>
              <season>%d</season>
              <episode>%d</episode>
              <aired>%s</aired>
              <plot>%s</plot>
              <runtime>%s</runtime>
              <uniqueid type=\"tmdb\">%s</uniqueid>
              </episodedetails>" \
            "$(escape "$ETITLE")" "$S" "$E" "$EAIR" "$(escape "$EPLOT")" "$ERUNTIME" "$EID" \
            > "$NFO_FILE"

            echo "[OK] Episode NFO created: $NFO_FILE"
          done

          ########################################################
          # BUILD MOVIES
          ########################################################
          echo "== BUILDING MOVIES =="

          for KEY in "${!MOV_MAP[@]}"; do
            META="${MOV_META[$KEY]}"
            IFS='|' read MID MNAME MYEAR TS <<< "$META"

            MV=$(safe "$MNAME")
            MD="site_root/Movies/${MV} (${MYEAR})"
            mkdir -p "$MD"

            echo "${MOV_MAP[$KEY]}" > "$MD/${MV} (${MYEAR}).strm"

            DET=$(curl -s "https://api.themoviedb.org/3/movie/$MID?api_key=$TMDB")
            PLOT=$(echo "$DET" | jq -r '.overview // ""')
            RUNTIME=$(echo "$DET" | jq -r '.runtime // 0')

            printf "<movie><title>%s</title><year>%s</year><runtime>%s</runtime><plot>%s</plot></movie>" \
              "$(escape "$MNAME")" "$MYEAR" "$RUNTIME" "$(escape "$PLOT")" \
              > "$MD/movie.nfo"

            echo "[OK] Movie created: $MD"
          done

      - name: Upload to Koofr
        run: |
          echo "== UPLOAD =="
          cd site_root

          encode() { echo "$1" | sed 's/ /%20/g'; }

          find . -type d | while read D; do
            ENC=$(encode "${D#./}")
            curl -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
              -X MKCOL "${{ secrets.KOFR_URL }}$ENC/" || true
          done

          find . -type f | while read F; do
            ENC=$(encode "${F#./}")
            curl -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
              -T "$F" "${{ secrets.KOFR_URL }}$ENC" || true
          done

          echo "[OK] Upload complete."
