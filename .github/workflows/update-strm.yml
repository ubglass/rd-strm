name: Build Real-Debrid STRM Library (XML Indexing)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Prepare Folders
        run: |
          set +e
          rm -rf strm || true
          mkdir -p strm/Movies
          mkdir -p "strm/TV Shows"

      - name: Fetch RD Torrents
        run: |
          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
            "https://api.real-debrid.com/rest/1.0/torrents" \
            > torrents.json

      ###############################################
      # Build STRM + filelist.xml
      ###############################################

      - name: Build STRM Files
        run: |
          set +e
          CUTOFF=$(date -d "15 days ago" +%s)

          jq -c '.[]?' torrents.json | while read TORRENT; do

            ID=$(echo "$TORRENT" | jq -r '.id')
            NAME=$(echo "$TORRENT" | jq -r '.filename')
            ADDED=$(echo "$TORRENT" | jq -r '.added')

            [ -z "$ID" ] && continue
            [ -z "$ADDED" ] && continue

            ADDED_EPOCH=$(date -d "$ADDED" +%s 2>/dev/null || echo 0)
            if [ "$ADDED_EPOCH" -lt "$CUTOFF" ]; then
              echo "Skipping old torrent: $NAME"
              continue
            fi

            echo "Processing: $NAME"

            curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
              "https://api.real-debrid.com/rest/1.0/torrents/info/$ID" \
              > detail.json

            FILECOUNT=$(jq '.files | length' detail.json 2>/dev/null || echo 0)
            [ "$FILECOUNT" -lt 1 ] && continue

            for i in $(seq 0 $(($FILECOUNT - 1))); do

              FILE=$(jq -r ".files[$i].path" detail.json)
              LINK=$(jq -r ".links[$i]?" detail.json)

              BASENAME=$(basename "$FILE")
              EXT="${BASENAME##*.}"

              [[ ! "$EXT" =~ ^(mkv|mp4|avi|mov|m4v|webm)$ ]] && continue
              [ -z "$LINK" ] && continue
              [ "$LINK" = "null" ] && continue

              echo "â†’ Unrestricting $BASENAME"

              UNR=$(curl -s -X POST \
                -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
                -d "link=$LINK" \
                "https://api.real-debrid.com/rest/1.0/unrestrict/link")

              DIRECT=$(echo "$UNR" | jq -r '.download')
              [ -z "$DIRECT" ] && continue
              [ "$DIRECT" = "null" ] && continue

              ##################################################
              # TV Episode
              ##################################################
              if [[ "$BASENAME" =~ S[0-9][0-9]E[0-9][0-9] ]]; then

                SHOW=$(echo "$BASENAME" | sed -E 's/\.[Ss][0-9]+[Ee][0-9]+.*//;s/[._]/ /g')
                RAWSEASON=$(echo "$BASENAME" | grep -oE 'S[0-9]+' | tr -d S)
                RAWEp=$(echo "$BASENAME" | grep -oE 'E[0-9]+' | tr -d E)

                SNUM=$((10#$RAWSEASON))
                ENUM=$((10#$RAWEp))

                SEASONPATH="strm/TV Shows/$SHOW/Season $SNUM"
                mkdir -p "$SEASONPATH"

                OUT="$SEASONPATH/$SHOW S$(printf '%02d' $SNUM)E$(printf '%02d' $ENUM).strm"
                echo "$DIRECT" > "$OUT"

                continue
              fi

              ##################################################
              # MOVIE
              ##################################################
              TITLE=$(echo "$BASENAME" | sed -E 's/\.[0-9]{4}\..*//;s/[._]/ /g')
              YEAR=$(echo "$BASENAME" | grep -oE '[0-9]{4}' || echo "")

              OUT="strm/Movies/$TITLE ($YEAR).strm"
              echo "$DIRECT" > "$OUT"

            done
          done

      ###############################################
      # BUILD filelist.xml FOR EVERY FOLDER
      ###############################################

      - name: Generate filelist.xml
        run: |
          generate_xml() {
            DIR="$1"
            FILE="$DIR/filelist.xml"

            echo "<files>" > "$FILE"
            find "$DIR" -maxdepth 1 -type f -name "*.strm" | while read F; do
              BASE=$(basename "$F")
              echo "  <file>$BASE</file>" >> "$FILE"
            done
            echo "</files>" >> "$FILE"
          }

          # Movies
          generate_xml "strm/Movies"

          # TV Shows
          for show in "strm/TV Shows"/*; do
            [ -d "$show" ] || continue

            for season in "$show"/Season*; do
              [ -d "$season" ] || continue
              generate_xml "$season"
            done
          done

      ###############################################
      # DEPLOY TO GITHUB PAGES
      ###############################################
      - name: Upload Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: strm

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
      - uses: actions/deploy-pages@v4
