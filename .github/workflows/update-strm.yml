name: RD STRM Builder (Final Stable Version with Cleanup)

on:
  workflow_dispatch:
  schedule:
    - cron: "*/15 * * * *"

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare workspace
        run: |
          echo "== PREPARE =="
          rm -rf site_root
          mkdir -p site_root/Movies site_root/TV_Shows
          echo "[OK] Workspace prepared."

      - name: Fetch RD downloads
        run: |
          echo "== FETCH REAL-DEBRID DOWNLOADS =="
          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
            "https://api.real-debrid.com/rest/1.0/downloads" \
            > downloads.json
          echo "[DEBUG] RD JSON:"
          sed 's/^/ /' downloads.json

      - name: Build STRM Library with Cleanup
        run: |
          set +e
          echo "== BUILDING LIBRARY WITH CLEANUP =="
          
          TMDB="${{ secrets.TMDB_API_KEY }}"
          urlencode() { jq -nr --arg v "$1" '$v|@uri'; }
          escape() { echo "$1" | sed 's/%/%%/g'; }
          safe() { echo "$1" | sed 's#[^-_.a-zA-Z0-9 ()]#_#g'; }
          
          CUTOFF=$(date -d "15 days ago" +%s)
          echo "[DEBUG] CUTOFF TS = $CUTOFF"
          
          declare -A EP_MAP EP_META MOV_MAP MOV_META SHOW_META
          
          # === CLEANUP PHASE 1: Generate current keys ===
          echo "== CLEANUP: Mapping current RD movies/TV =="
          > current_keys.txt
          
          jq -r '.[] | select(.streamable=="1") | .filename' downloads.json | \
          while read FILE; do
            BASE=$(basename "$FILE")
            NAME="${BASE%.*}"
            
            if [[ $NAME =~ [Ss][0-9]{1,2}[Ee][0-9]{1,2} ]]; then
              RAW=$(echo "$NAME" | sed -E 's/[_\\.]/ /g' | sed -E 's/[Ss][0-9]{1,2}[Ee][0-9]{1,2}.*//' | sed 's/ */ /g; s/ $//')
              YEAR=$(echo "$RAW" | grep -oE '(19[0-9]{2}|20[0-3][0-9])')
              SHOW_SAFE=$(echo "$RAW" | sed 's/[^a-zA-Z0-9]/_/g')
              [[ -n $YEAR ]] && SHOW_KEY="$SHOW_SAFE ($YEAR)" || SHOW_KEY="$SHOW_SAFE"
              echo "keep-tv:$SHOW_KEY" >> current_keys.txt
            else
              RAW=$(echo "$NAME" | sed -E 's/[_\\.]/ /g' | sed 's/ */ /g; s/ $//')
              YEAR=$(echo "$RAW" | grep -oE '(19[0-9]{2}|20[0-3][0-9])' | head -1)
              [[ -n $YEAR ]] && CLEAN=$(echo "$RAW" | sed -E "s/$YEAR.*//") || CLEAN="$RAW"
              CLEAN=$(echo "$CLEAN" | sed 's/ */ /g; s/ $//')
              MV_SAFE=$(safe "$CLEAN")
              MOV_KEY="${MV_SAFE} ($YEAR)"
              echo "keep-movie:$MOV_KEY" >> current_keys.txt
            fi
          done
          
          echo "[DEBUG] Current keys: $(wc -l < current_keys.txt)"
          
          # === LOCAL CLEANUP: Remove stale folders ===
          echo "== LOCAL CLEANUP =="
          for DIR in site_root/Movies/*/; do
            [ -d "$DIR" ] || continue
            KEY=$(basename "$DIR")
            if ! grep -q "keep-movie:$KEY" current_keys.txt 2>/dev/null; then
              echo "[DELETE] Stale movie: $DIR"
              rm -rf "$DIR"
            fi
          done
          
          for DIR in site_root/TV_Shows/*/; do
            [ -d "$DIR" ] || continue
            KEY=$(basename "$DIR")
            if ! grep -q "keep-tv:$KEY" current_keys.txt 2>/dev/null; then
              echo "[DELETE] Stale TV: $DIR"
              rm -rf "$DIR"
            fi
          done
          rm -f current_keys.txt
          
          # === ORIGINAL PARSING LOGIC ===
          echo "== START PARSING DOWNLOADS =="
          while read -r DL; do
            echo ""
            echo "---------------- NEW ENTRY ----------------"
            echo "$DL" | sed 's/^/ /'
            
            FILE=$(echo "$DL" | jq -r '.filename // ""')
            LINK=$(echo "$DL" | jq -r '.download // ""')
            STREAM=$(echo "$DL" | jq -r '.streamable // 0')
            GEN=$(echo "$DL" | jq -r '.generated // ""')
            
            echo "[DEBUG] FILE=$FILE"
            TS=$(echo "$GEN" | sed 's/\..*Z//; s/T/ /' | xargs -I{} date -d "{}" +%s 2>/dev/null || echo 0)
            
            [ "$STREAM" != "1" ] && echo "[SKIP] Not streamable." && continue
            [ "$TS" -lt "$CUTOFF" ] && echo "[SKIP] Too old." && continue
            
            BASE=$(basename "$FILE")
            EXT="${BASE##*.}"
            NAME="${BASE%.*}"
            [[ ! "$EXT" =~ ^(mkv|mp4|avi|mov|webm)$ ]] && echo "[SKIP] Unsupported." && continue
            
            # TV DETECTION
            if [[ "$NAME" =~ [Ss][0-9]{1,2}[Ee][0-9]{1,2} ]]; then
              SE_BLOCK=$(echo "$NAME" | grep -oEi "S[0-9]{1,2}E[0-9]{1,2}" | head -1)
              S=$(echo "$SE_BLOCK" | sed -E 's/^S([0-9]{1,2})E[0-9]{1,2}$/\1/I')
              E=$(echo "$SE_BLOCK" | sed -E 's/^S[0-9]{1,2}E([0-9]{1,2})$/\1/I')
              S=$((10#$S))
              E=$((10#$E))
              
              RAW=$(echo "$NAME" | sed -E 's/[_\\.]/ /g' | sed -E 's/[Ss][0-9]{1,2}[Ee][0-9]{1,2}.*//' | sed 's/ */ /g; s/ $//')
              YEAR=$(echo "$RAW" | grep -oE '(19[0-9]{2}|20[0-3][0-9])')
              [[ -n $YEAR ]] && SEARCH_TITLE=$(echo "$RAW" | sed -E "s/$YEAR//" | sed 's/ */ /g; s/ $//') || SEARCH_TITLE="$RAW"
              
              ENC=$(urlencode "$SEARCH_TITLE")
              [[ -n $YEAR ]] && SEARCH=$(curl -s "https://api.themoviedb.org/3/search/tv?api_key=$TMDB&query=$ENC&first_air_date_year=$YEAR") || SEARCH=$(curl -s "https://api.themoviedb.org/3/search/tv?api_key=$TMDB&query=$ENC")
              
              [[ "$(echo "$SEARCH" | jq '.results | length')" -eq 0 && -n "$YEAR" ]] && SEARCH=$(curl -s "https://api.themoviedb.org/3/search/tv?api_key=$TMDB&query=$ENC")
              
              TID=$(echo "$SEARCH" | jq -r '.results | if length == 0 then [] else . end | map(select(.adult != true)) | sort_by(-.popularity) | .[0].id // empty')
              [[ -z $TID ]] && echo "[SKIP] No TV match." && continue
              
              TNAME=$(echo "$SEARCH" | jq -r --argjson tid "$TID" '.results | map(select(.id == $tid)) | .[0].name')
              TYEAR=$(echo "$SEARCH" | jq -r --argjson tid "$TID" '.results | map(select(.id == $tid)) | .[0].first_air_date' | cut -c1-4)
              
              KEY="tv_${TID}_S${S}_E${E}"
              EP_MAP[$KEY]="$LINK"
              EP_META[$KEY]="$TID|$TNAME|$TYEAR|$S|$E|$TS"
              
              SHOWKEY="show_${TID}"
              [[ -z ${SHOW_META[$SHOWKEY]} ]] && SHOW_META[$SHOWKEY]="$TID|$TNAME|$TYEAR"
              continue
            fi
            
            # MOVIE DETECTION
            RAW=$(echo "$NAME" | sed -E 's/[_\\.]/ /g' | sed 's/ */ /g; s/ $//')
            YEAR=$(echo "$RAW" | grep -oE '(19[0-9]{2}|20[0-3][0-9])' | head -1)
            [[ -n $YEAR ]] && CLEAN=$(echo "$RAW" | sed -E "s/$YEAR.*//") || CLEAN="$RAW"
            CLEAN=$(echo "$CLEAN" | sed 's/ */ /g; s/ $//')
            
            tmdb_search() {
              local ENC=$(urlencode "$1")
              [[ -n $2 ]] && curl -s "https://api.themoviedb.org/3/search/movie?api_key=$TMDB&query=$ENC&year=$2" || curl -s "https://api.themoviedb.org/3/search/movie?api_key=$TMDB&query=$ENC"
            }
            
            SEARCH=$(tmdb_search "$CLEAN" "$YEAR")
            [[ "$(echo "$SEARCH" | jq '.results | length')" -eq 0 && -n "$YEAR" ]] && SEARCH=$(tmdb_search "$CLEAN" "")
            
            MID=$(echo "$SEARCH" | jq -r '.results | if length == 0 then [] else . end | (map(select(.video == false)) + .) | unique_by(.id) | sort_by(-.popularity) | .[0].id // empty')
            [[ -z $MID ]] && echo "[SKIP] No movie match." && continue
            
            MNAME=$(echo "$SEARCH" | jq -r --argjson mid "$MID" '.results | map(select(.id == $mid)) | .[0].title')
            MYEAR=$(echo "$SEARCH" | jq -r --argjson mid "$MID" '.results | map(select(.id == $mid)) | .[0].release_date' | cut -c1-4)
            
            KEY="movie_${MID}"
            MOV_MAP[$KEY]="$LINK"
            MOV_META[$KEY]="$MID|$MNAME|$MYEAR|$TS"
          done < <(jq -c 'if type=="array" then .[] else . end' downloads.json)
          
          echo "== SUMMARY =="
          echo "TV EPISODES: ${#EP_MAP[@]}"
          echo "MOVIES: ${#MOV_MAP[@]}"
          
          # BUILD TV SHOWS
          echo "== BUILDING TV SHOW NFO =="
          TV_ROOT="site_root/TV_Shows"
          mkdir -p "$TV_ROOT"
          for SHOWKEY in "${!SHOW_META[@]}"; do
            IFS='|' read -r TID TNAME TYEAR <<< "${SHOW_META[$SHOWKEY]}"
            SHOW_DIR="$TV_ROOT/${TNAME} (${TYEAR})"
            mkdir -p "$SHOW_DIR"
            
            SHOW_DET=$(curl -s "https://api.themoviedb.org/3/tv/$TID?api_key=$TMDB")
            SHOW_PLOT=$(echo "$SHOW_DET" | jq -r '.overview // ""')
            SHOW_POSTER=$(echo "$SHOW_DET" | jq -r '.poster_path // ""')
            SHOW_FANART=$(echo "$SHOW_DET" | jq -r '.backdrop_path // ""')
            [[ "$SHOW_POSTER" != "" ]] && POSTER_URL="https://image.tmdb.org/t/p/original${SHOW_POSTER}" || POSTER_URL=""
            [[ "$SHOW_FANART" != "" ]] && FANART_URL="https://image.tmdb.org/t/p/original${SHOW_FANART}" || FANART_URL=""
            
            SHOW_NFO="$SHOW_DIR/tvshow.nfo"
            cp "templates/tvshow_template.nfo" "$SHOW_NFO"
            sed -i "s|{TITLE}|$(escape "$TNAME")|g" "$SHOW_NFO"
            sed -i "s|{YEAR}|$TYEAR|g" "$SHOW_NFO"
            sed -i "s|{TMDB_ID}|$TID|g" "$SHOW_NFO"
            sed -i "s|{POSTER_URL}|$POSTER_URL|g" "$SHOW_NFO"
            sed -i "s|{FANART_URL}|$FANART_URL|g" "$SHOW_NFO"
            sed -i "s|{PLOT}|$(escape "$SHOW_PLOT")|g" "$SHOW_NFO"
          done
          
          # BUILD TV EPISODES
          echo "== BUILDING TV EPISODES =="
          for SHOWKEY in "${!SHOW_META[@]}"; do
            IFS='|' read -r TID TNAME TYEAR <<< "${SHOW_META[$SHOWKEY]}"
            SHOW_DIR="$TV_ROOT/${TNAME} (${TYEAR})"
            mkdir -p "$SHOW_DIR"
            
            for EPKEY in "${!EP_MAP[@]}"; do
              [[ "$EPKEY" != tv_"${TID}"_* ]] && continue
              IFS='|' read -r ETID ETNAME ETYEAR ES EE ETS <<< "${EP_META[$EPKEY]}"
              SEASON_PAD=$(printf "%02d" "$ES")
              EP_PAD=$(printf "%02d" "$EE")
              SEASON_DIR="$SHOW_DIR/Season $SEASON_PAD"
              mkdir -p "$SEASON_DIR"
              EP_TITLE="${TNAME} S${SEASON_PAD}E${EP_PAD}"
              STRM_PATH="$SEASON_DIR/${EP_TITLE}.strm"
              NFO_PATH="$SEASON_DIR/${EP_TITLE}.nfo"
              echo "${EP_MAP[$EPKEY]}" > "$STRM_PATH"
              
              EP_DET=$(curl -s "https://api.themoviedb.org/3/tv/${TID}/season/${ES}/episode/${EE}?api_key=$TMDB")
              EP_PLOT=$(echo "$EP_DET" | jq -r '.overview // ""')
              EP_POSTER=$(echo "$EP_DET" | jq -r '.still_path // ""')
              RUNTIME=$(echo "$EP_DET" | jq -r '.runtime // empty')
              [[ "$EP_POSTER" != "" ]] && EP_POSTER_URL="https://image.tmdb.org/t/p/original${EP_POSTER}" || EP_POSTER_URL=""
              
              cat > "$NFO_PATH" << EOF
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<episodedetails>
  <title>$EP_TITLE</title>
  <season>$ES</season>
  <episode>$EE</episode>
  <showtitle>$TNAME</showtitle>
  <year>$ETYEAR</year>
  <tmdbid>$ETID</tmdbid>
  <runtime>$RUNTIME</runtime>
  <plot>$EP_PLOT</plot>
  <thumb>$EP_POSTER_URL</thumb>
</episodedetails>
EOF
            done
          done
          
          # BUILD MOVIES
          echo "== BUILDING MOVIES =="
          for KEY in "${!MOV_MAP[@]}"; do
            IFS='|' read MID MNAME MYEAR TS <<< "${MOV_META[$KEY]}"
            MV=$(safe "$MNAME")
            MD="site_root/Movies/${MV} (${MYEAR})"
            mkdir -p "$MD"
            STRM_PATH="$MD/${MV} (${MYEAR}).strm"
            echo "${MOV_MAP[$KEY]}" > "$STRM_PATH"
            
            DET=$(curl -s "https://api.themoviedb.org/3/movie/$MID?api_key=$TMDB")
            PLOT=$(echo "$DET" | jq -r '.overview // ""')
            POSTER=$(echo "$DET" | jq -r '.poster_path // ""')
            FANART=$(echo "$DET" | jq -r '.backdrop_path // ""')
            RUNTIME=$(echo "$DET" | jq -r '.runtime // empty')
            [[ "$POSTER" != "" ]] && POSTER_URL="https://image.tmdb.org/t/p/original${POSTER}" || POSTER_URL=""
            [[ "$FANART" != "" ]] && FANART_URL="https://image.tmdb.org/t/p/original${FANART}" || FANART_URL=""
            
            NFO_PATH="$MD/${MV} (${MYEAR}).nfo"
            cp "templates/movie_template.nfo" "$NFO_PATH"
            sed -i "s|{TITLE}|$(escape "$MNAME")|g" "$NFO_PATH"
            sed -i "s|{YEAR}|$MYEAR|g" "$NFO_PATH"
            sed -i "s|{TMDB_ID}|$MID|g" "$NFO_PATH"
            sed -i "s|{POSTER_URL}|$POSTER_URL|g" "$NFO_PATH"
            sed -i "s|{FANART_URL}|$FANART_URL|g" "$NFO_PATH"
            sed -i "s|{PLOT}|$(escape "$PLOT")|g" "$NFO_PATH"
            sed -i "s|{RUNTIME}|$RUNTIME|g" "$NFO_PATH"
          done[file:1]

      - name: Koofr Full Sync with Cleanup
        run: |
          echo "== KOOFR FULL SYNC WITH CLEANUP =="
          cd site_root
          
          encode() { echo "$1" | sed 's/ /%20/g; s/\((\|)\)/%\1/g'; }
          KOFR_URL="${{ secrets.KOFR_URL }}"
          KOFR_USER="${{ secrets.KOFR_USER }}"
          KOFR_PASS="${{ secrets.KOFR_PASS }}"
          
          # === STEP 1: Create local directories ===
          find . -type d | tail -n +2 | while read D; do
            ENC=$(encode "${D#./}")
            echo "[KOFR] MKCOL $ENC/"
            timeout 30 curl -s -u "$KOFR_USER:$KOFR_PASS" -X MKCOL "$KOFR_URL$ENC/" || echo "[WARN] MKCOL $ENC"
          done
          
          # === STEP 2: Upload local files ===
          find . -type f | while read F; do
            ENC=$(encode "${F#./}")
            echo "[KOFR] PUT $ENC"
            timeout 60 curl -s -u "$KOFR_USER:$KOFR_PASS" -T "$F" "$KOFR_URL$ENC" || echo "[WARN] PUT $ENC"
          done
          
          # === STEP 3: FULL CLEANUP - Delete remote orphans ===
          echo "== KOOFR ORPHAN CLEANUP =="
          # Get ALL remote contents via PROPFIND
          REMOTE_LIST=$(timeout 30 curl -s -u "$KOFR_USER:$KOFR_PASS" -X PROPFIND -H "Depth: infinity" "$KOFR_URL" | grep -oP 'href="[^"]+"' | sed 's/href="//; s/"$//' | grep -E '(Movies|TV_Shows)/')
          
          echo "$REMOTE_LIST" | while read REMOTE_PATH; do
            [[ -z $REMOTE_PATH ]] && continue
            LOCAL_PATH="site_root/$REMOTE_PATH"
            
            # Skip if still exists locally (new content)
            [[ -e $LOCAL_PATH ]] && continue
            
            echo "[DELETE] Orphan on Koofr: $REMOTE_PATH"
            ENC=$(encode "$REMOTE_PATH")
            timeout 30 curl -s -u "$KOFR_USER:$KOFR_PASS" -X DELETE "$KOFR_URL$ENC" || echo "[WARN] DELETE failed: $ENC"
          done
          
          echo "== KOOFR SYNC COMPLETE =="[file:1]
