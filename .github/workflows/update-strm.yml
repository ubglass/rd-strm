name: RD STRM Builder (Stable + Artwork URLs)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get install -y jq

      - name: Prepare workspace
        run: |
          rm -rf site_root
          mkdir -p site_root/Movies
          mkdir -p site_root/TV_Shows

      - name: Fetch RD downloads
        run: |
          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
            "https://api.real-debrid.com/rest/1.0/downloads" \
            | jq "." > rd.json

      - name: Process items
        run: |
          TMDB="${{ secrets.TMDB_API_KEY }}"

          jq -c '.[]' rd.json | while read ITEM; do
            FN=$(echo "$ITEM" | jq -r '.filename')
            DL=$(echo "$ITEM" | jq -r '.download')

            # Detect movie by year
            YEAR=$(echo "$FN" | grep -oE '(19|20)[0-9]{2}' | head -1)

            # Detect SxxEyy
            if [[ "$FN" =~ S([0-9]{2})E([0-9]{2}) ]]; then
              S=${BASH_REMATCH[1]}
              E=${BASH_REMATCH[2]}
            else
              S=""
              E=""
            fi

            ###############################################
            # MOVIE PROCESSING
            ###############################################
            if [ -n "$YEAR" ] && [ -z "$S" ]; then
              NAME=$(echo "$FN" | sed -E 's/\.[^.]+$//' | sed -E "s/$YEAR.*//" | sed 's/\.$//')

              # TMDB search
              Q=$(jq -rn --arg v "$NAME" '$v|@uri')
              RES=$(curl -s "https://api.themoviedb.org/3/search/movie?api_key=$TMDB&query=$Q&year=$YEAR")
              MID=$(echo "$RES" | jq -r '.results[0].id // empty')

              [ -z "$MID" ] && continue

              # TMDB details
              DET=$(curl -s "https://api.themoviedb.org/3/movie/$MID?api_key=$TMDB")

              PLOT=$(echo "$DET" | jq -r '.overview // ""')
              RUNTIME=$(echo "$DET" | jq -r '.runtime // 0')
              DATE=$(echo "$DET" | jq -r '.release_date // ""')
              POSTER=$(echo "$DET" | jq -r '.poster_path // ""')
              FANART=$(echo "$DET" | jq -r '.backdrop_path // ""')

              MD="site_root/Movies/${NAME} (${YEAR})"
              mkdir -p "$MD"

              STRM="$MD/${NAME} (${YEAR}).strm"
              NFO="$MD/${NAME} (${YEAR}).nfo"

              echo "$DL" > "$STRM"

              # MOVIE NFO (printf only)
              printf "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n" > "$NFO"
              printf "<movie>\n" >> "$NFO"
              printf "  <title>%s</title>\n" "$NAME" >> "$NFO"
              printf "  <originaltitle>%s</originaltitle>\n" "$NAME" >> "$NFO"
              printf "  <year>%s</year>\n" "$YEAR" >> "$NFO"
              printf "  <premiered>%s</premiered>\n" "$DATE" >> "$NFO"
              printf "  <plot>%s</plot>\n" "$(echo "$PLOT" | sed 's/&/&amp;/g')" >> "$NFO"
              printf "  <runtime>%s</runtime>\n" "$RUNTIME" >> "$NFO"
              printf "  <uniqueid type=\"tmdb\" default=\"true\">%s</uniqueid>\n" "$MID" >> "$NFO"
              printf "  <id>%s</id>\n" "$MID" >> "$NFO"
              printf "  <thumb>https://image.tmdb.org/t/p/w500%s</thumb>\n" "$POSTER" >> "$NFO"
              printf "  <fanart>https://image.tmdb.org/t/p/w500%s</fanart>\n" "$FANART" >> "$NFO"
              printf "</movie>\n" >> "$NFO"

              continue
            fi

            ###############################################
            # TV EPISODE PROCESSING
            ###############################################
            if [ -n "$S" ] && [ -n "$E" ]; then
              # Extract show name
              SHOWNAME=$(echo "$FN" | sed -E 's/S[0-9]{2}E[0-9]{2}.*//' | sed -E 's/\.[^.]+$//')
              YEAR=$(echo "$FN" | grep -oE '(19|20)[0-9]{2}' | head -1)

              [ -z "$YEAR" ] && continue

              Q=$(jq -rn --arg v "$SHOWNAME" '$v|@uri')
              RES=$(curl -s "https://api.themoviedb.org/3/search/tv?api_key=$TMDB&query=$Q&first_air_date_year=$YEAR")
              TID=$(echo "$RES" | jq -r '.results[0].id // empty')

              [ -z "$TID" ] && continue

              # Show details
              SDET=$(curl -s "https://api.themoviedb.org/3/tv/$TID?api_key=$TMDB")
              TPLOT=$(echo "$SDET" | jq -r '.overview // ""')
              TPREM=$(echo "$SDET" | jq -r '.first_air_date // ""')
              TPOSTER=$(echo "$SDET" | jq -r '.poster_path // ""')
              TFANART=$(echo "$SDET" | jq -r '.backdrop_path // ""')

              SHOWDIR="site_root/TV_Shows/${SHOWNAME} (${YEAR})"
              mkdir -p "$SHOWDIR"

              # TVSHOW NFO
              if [ ! -f "$SHOWDIR/tvshow.nfo" ]; then
                NFO="$SHOWDIR/tvshow.nfo"
                printf "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n" > "$NFO"
                printf "<tvshow>\n" >> "$NFO"
                printf "  <title>%s</title>\n" "$SHOWNAME" >> "$NFO"
                printf "  <year>%s</year>\n" "$YEAR" >> "$NFO"
                printf "  <premiered>%s</premiered>\n" "$TPREM" >> "$NFO"
                printf "  <plot>%s</plot>\n" "$(echo "$TPLOT" | sed 's/&/&amp;/g')" >> "$NFO"
                printf "  <uniqueid type=\"tmdb\" default=\"true\">%s</uniqueid>\n" "$TID" >> "$NFO"
                printf "  <id>%s</id>\n" "$TID" >> "$NFO"
                printf "  <thumb>https://image.tmdb.org/t/p/w500%s</thumb>\n" "$TPOSTER" >> "$NFO"
                printf "  <fanart>https://image.tmdb.org/t/p/w500%s</fanart>\n" "$TFANART" >> "$NFO"
                printf "</tvshow>\n" >> "$NFO"
              fi

              # EPISODE DETAILS
              EDET=$(curl -s "https://api.themoviedb.org/3/tv/$TID/season/$((10#$S))/episode/$((10#$E))?api_key=$TMDB")

              EP_TITLE=$(echo "$EDET" | jq -r '.name // ""')
              EP_PLOT=$(echo "$EDET" | jq -r '.overview // ""')
              EP_DATE=$(echo "$EDET" | jq -r '.air_date // ""')
              EP_RT=$(echo "$EDET" | jq -r '.runtime // 0')
              EP_ID=$(echo "$EDET" | jq -r '.id // ""')
              EP_STILL=$(echo "$EDET" | jq -r '.still_path // ""')

              SEASON_DIR="$SHOWDIR/Season $((10#$S))"
              mkdir -p "$SEASON_DIR"

              BASE="${SHOWNAME} (${YEAR}) - S$(printf '%02d' "$S")E$(printf '%02d' "$E")"

              STRM="$SEASON_DIR/${BASE}.strm"
              NFO="$SEASON_DIR/${BASE}.nfo"

              echo "$DL" > "$STRM"

              # EPISODE NFO
              printf "<?xml version=\"1.0\" encoding=\"UTF-8\" standalone=\"yes\"?>\n" > "$NFO"
              printf "<episodedetails>\n" >> "$NFO"
              printf "  <title>%s</title>\n" "$EP_TITLE" >> "$NFO"
              printf "  <season>%s</season>\n" "$S" >> "$NFO"
              printf "  <episode>%s</episode>\n" "$E" >> "$NFO"
              printf "  <aired>%s</aired>\n" "$EP_DATE" >> "$NFO"
              printf "  <plot>%s</plot>\n" "$(echo "$EP_PLOT" | sed 's/&/&amp;/g')" >> "$NFO"
              printf "  <runtime>%s</runtime>\n" "$EP_RT" >> "$NFO"
              printf "  <uniqueid type=\"tmdb\" default=\"true\">%s</uniqueid>\n" "$EP_ID" >> "$NFO"
              printf "  <id>%s</id>\n" "$EP_ID" >> "$NFO"
              printf "  <thumb>https://image.tmdb.org/t/p/w500%s</thumb>\n" "$EP_STILL" >> "$NFO"
              printf "</episodedetails>\n" >> "$NFO"

            fi

          done

      - name: Upload to Koofr
        run: |
          find site_root -type f | while read FILE; do
            REL=$(echo "$FILE" | sed 's#site_root/##')
            DEST="${{ secrets.KOFR_URL }}$(printf '%s' "$REL" | sed 's/ /%20/g')"
            echo "Uploading: $REL"
            curl -s -T "$FILE" -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" "$DEST"
          done
