name: RD STRM Builder + Koofr Sync + GitHub Pages

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Prepare site_root
        run: |
          rm -rf site_root
          mkdir -p site_root/Movies
          mkdir -p site_root/TV_Shows

      - name: Disable Jekyll
        run: |
          echo "theme: null" > site_root/_config.yml

      - name: Create root index
        run: |
          printf "<h1>RD STRM Library</h1>\n<ul>\n<li><a href='Movies/'>Movies</a></li>\n<li><a href='TV_Shows/'>TV Shows</a></li>\n</ul>" \
            > site_root/index.html

      - name: Fetch Real-Debrid data
        run: |
          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
            "https://api.real-debrid.com/rest/1.0/torrents" > torrents.json

          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
            "https://api.real-debrid.com/rest/1.0/downloads" > downloads.json

      - name: Build STRM library
        run: |
          set +e
          TMDB_KEY="${{ secrets.TMDB_API_KEY }}"
          CUTOFF=$(date -d "15 days ago" +%s)

          get_direct_cdn_url() {
            FILE="$1"
            jq -c ".[] | select(.filename == \"$FILE\" and .streamable == 1)" downloads.json \
              | jq -s "sort_by(.generated) | last | .download"
          }

          jq -c '.[]?' torrents.json | while read TOR; do

            ID=$(echo "$TOR" | jq -r '.id')
            ADDED=$(echo "$TOR" | jq -r '.added')
            ADDED_EPOCH=$(date -d "$ADDED" +%s 2>/dev/null || echo 0)
            [ "$ADDED_EPOCH" -lt "$CUTOFF" ] && continue

            curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
              "https://api.real-debrid.com/rest/1.0/torrents/info/$ID" \
              > detail.json

            COUNT=$(jq '.files | length' detail.json)

            for i in $(seq 0 $(($COUNT - 1))); do

              FILE=$(jq -r ".files[$i].path" detail.json)
              BASENAME=$(basename "$FILE")
              EXT="${BASENAME##*.}"
              [[ ! "$EXT" =~ ^(mkv|mp4|avi|mov|webm)$ ]] && continue

              DIRECT=$(get_direct_cdn_url "$BASENAME")

              if [ -z "$DIRECT" ] || [ "$DIRECT" = "null" ]; then
                LINK=$(jq -r ".links[$i]?" detail.json)
                UNR=$(curl -s -X POST \
                  -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
                  -d "link=$LINK" \
                  "https://api.real-debrid.com/rest/1.0/unrestrict/link")
                DIRECT=$(echo "$UNR" | jq -r '.download')
              fi

              [ -z "$DIRECT" ] || [ "$DIRECT" = "null" ] && continue

              ################################################################
              # TV SHOWS
              ################################################################
              if [[ "$BASENAME" =~ [Ss][0-9][0-9][Ee][0-9][0-9] ]]; then

                RAW_SHOW=$(echo "$BASENAME" | sed -E 's/\.[Ss][0-9]+.*//' | sed 's/[._]/ /g')
                CLEAN_SHOW=$(echo "$RAW_SHOW" | sed -E 's/ +/ /g')

                YEAR=$(echo "$BASENAME" | grep -oE '(19[0-9]{2}|20[0-3][0-9])')
                if [ -n "$YEAR" ]; then
                  SHOWDIR="site_root/TV_Shows/${CLEAN_SHOW} (${YEAR})"
                else
                  SHOWDIR="site_root/TV_Shows/${CLEAN_SHOW}"
                fi
                mkdir -p "$SHOWDIR"

                if [ ! -f "$SHOWDIR/.tmdb_id" ]; then
                  TVJSON=$(curl -s \
                    "https://api.themoviedb.org/3/search/tv?api_key=$TMDB_KEY&query=$CLEAN_SHOW")
                  SID=$(echo "$TVJSON" | jq -r '.results[0].id')
                  echo "$SID" > "$SHOWDIR/.tmdb_id"

                  DETAILS=$(curl -s \
                    "https://api.themoviedb.org/3/tv/$SID?api_key=$TMDB_KEY")
                  PLOT=$(echo "$DETAILS" | jq -r '.overview // ""')
                  RUNTIME=$(echo "$DETAILS" | jq -r '.episode_run_time[0] // 0')

                  printf "<tvshow>\n<title>%s</title>\n<plot>%s</plot>\n<runtime>%s</runtime>\n</tvshow>" \
                    "$CLEAN_SHOW" "$PLOT" "$RUNTIME" \
                    > "$SHOWDIR/tvshow.nfo"
                fi

                SID=$(cat "$SHOWDIR/.tmdb_id")

                SNUM=$(echo "$BASENAME" | grep -oE '[Ss][0-9]+' | sed 's/S//I')
                ENUM=$(echo "$BASENAME" | grep -oE '[Ee][0-9]+' | sed 's/E//I')
                SNUM=$((10#$SNUM))
                ENUM=$((10#$ENUM))

                SEASON_DIR="$SHOWDIR/Season $(printf '%02d' $SNUM)"
                mkdir -p "$SEASON_DIR"

                STRM="$SEASON_DIR/${CLEAN_SHOW} S$(printf '%02d' $SNUM)E$(printf '%02d' $ENUM).strm"
                echo "$DIRECT" > "$STRM"

                EPJSON=$(curl -s \
                  "https://api.themoviedb.org/3/tv/$SID/season/$SNUM/episode/$ENUM?api_key=$TMDB_KEY")
                EPLOT=$(echo "$EPJSON" | jq -r '.overview // ""')
                EDATE=$(echo "$EPJSON" | jq -r '.air_date // ""')

                printf "<episodedetails>\n<title>%s</title>\n<season>%s</season>\n<episode>%s</episode>\n<aired>%s</aired>\n<plot>%s</plot>\n</episodedetails>" \
                  "$CLEAN_SHOW" "$SNUM" "$ENUM" "$EDATE" "$EPLOT" \
                  > "$SEASON_DIR/${CLEAN_SHOW} S$(printf '%02d' $SNUM)E$(printf '%02d' $ENUM).nfo"

                continue
              fi

              ################################################################
              # MOVIES
              ################################################################
              RAW=$(echo "$BASENAME" | sed -E 's/[._]/ /g')
              YEAR=$(echo "$RAW" | grep -oE '(19[0-9]{2}|20[0-3][0-9])')
              TITLE=$(echo "$RAW" | sed -E "s/$YEAR.*//" | sed 's/  */ /g')

              MOVIEDIR="site_root/Movies/${TITLE} (${YEAR})"
              mkdir -p "$MOVIEDIR"

              echo "$DIRECT" > "$MOVIEDIR/${TITLE} (${YEAR}).strm"

              MOVJSON=$(curl -s \
                "https://api.themoviedb.org/3/search/movie?api_key=$TMDB_KEY&query=$TITLE")
              MID=$(echo "$MOVJSON" | jq -r '.results[0].id')

              DETAILS=$(curl -s \
                "https://api.themoviedb.org/3/movie/$MID?api_key=$TMDB_KEY")
              MPLOT=$(echo "$DETAILS" | jq -r '.overview // ""')
              MRUN=$(echo "$DETAILS" | jq -r '.runtime // 0')

              printf "<movie>\n<title>%s</title>\n<year>%s</year>\n<runtime>%s</runtime>\n<plot>%s</plot>\n</movie>" \
                "$TITLE" "$YEAR" "$MRUN" "$MPLOT" \
                > "$MOVIEDIR/movie.nfo"

            done
          done

      - name: Build directory indexes
        run: |
          find site_root -type d | while read DIR; do
            HTML="$DIR/index.html"
            printf "<h2>%s</h2><ul>" "$(basename "$DIR")" > "$HTML"

            for ITEM in "$DIR"/*; do
              NAME=$(basename "$ITEM")
              if [ -d "$ITEM" ]; then
                printf "<li><a href='%s/'>%s/</a></li>" "$NAME" "$NAME" >> "$HTML"
              else
                printf "<li><a href='%s'>%s</a></li>" "$NAME" "$NAME" >> "$HTML"
              fi
            done

            printf "</ul>" >> "$HTML"
          done

      - name: Upload artifact for GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: site_root

      - name: Delete Koofr directory
        run: |
          curl -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
            -X DELETE "${{ secrets.KOFR_URL }}"

          curl -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
            -X MKCOL "${{ secrets.KOFR_URL }}"

      - name: Upload to Koofr
        run: |
          cd site_root
          encode() { echo "$1" | sed 's/ /%20/g'; }

          find . -type d | while read DIR; do
            PATHENC=$(encode "${DIR#./}")
            curl -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
              -X MKCOL "${{ secrets.KOFR_URL }}$PATHENC/" || true
          done

          find . -type f | while read FILE; do
            PATHENC=$(encode "${FILE#./}")
            curl -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
              -T "$FILE" "${{ secrets.KOFR_URL }}$PATHENC" || true
          done

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
