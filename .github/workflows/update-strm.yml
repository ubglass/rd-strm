name: Build Real-Debrid STRM Library (Safe Mode)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare folders
        run: |
          set +e
          rm -rf strm || true
          mkdir -p strm/Movies || true
          mkdir -p "strm/TV Shows" || true

      - name: Fetch RD torrents list
        run: |
          set +e
          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
            "https://api.real-debrid.com/rest/1.0/torrents" \
            > torrents.json || true
          cat torrents.json || true

      - name: Build STRM files (Error-Proof)
        run: |
          set +e
          
          jq -c '.[]?' torrents.json | while read TORRENT; do
            ID=$(echo "$TORRENT" | jq -r '.id' 2>/dev/null || true)
            NAME=$(echo "$TORRENT" | jq -r '.filename' 2>/dev/null || true)

            if [ -z "$ID" ]; then
              echo "Skipping malformed torrent entry"
              continue
            fi

            echo ""
            echo "Processing torrent: $NAME"

            curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
              "https://api.real-debrid.com/rest/1.0/torrents/info/$ID" \
              > detail.json || true

            FILECOUNT=$(jq '.files | length' detail.json 2>/dev/null || echo 0)

            if [ "$FILECOUNT" -lt 1 ]; then
              echo "No files — skipping torrent"
              continue
            fi

            for i in $(seq 0 $(($FILECOUNT - 1))); do

              FILE=$(jq -r ".files[$i].path" detail.json 2>/dev/null || echo "")
              LINK=$(jq -r ".links[$i]?" detail.json 2>/dev/null || echo "")

              BASENAME=$(basename "$FILE" 2>/dev/null || echo "")
              EXT="${BASENAME##*.}"

              # Skip empty or invalid
              if [ -z "$LINK" ] || [ "$LINK" = "null" ]; then
                echo "Skipping (no RD link): $BASENAME"
                continue
              fi

              # Only video formats
              if [[ ! "$EXT" =~ ^(mkv|mp4|mov|avi|webm|m4v)$ ]]; then
                echo "Skipping non-video: $BASENAME"
                continue
              fi

              echo "→ Valid video: $BASENAME"

              #
              # TV EPISODES — with ERROR SAFE numeric parsing
              #
              if [[ "$BASENAME" =~ S[0-9][0-9]E[0-9][0-9] ]]; then
                SHOW=$(echo "$BASENAME" | sed -E 's/\.[Ss][0-9]+[Ee][0-9]+.*//; s/[._]/ /g' || true)

                RAWSEASON=$(echo "$BASENAME" | grep -oE 'S[0-9]+' | tr -d S || echo "1")
                RAWEp=$(echo "$BASENAME" | grep -oE 'E[0-9]+' | tr -d E || echo "1")

                # SAFE decimal conversion
                SEASON_DEC=$((10#$RAWSEASON))
                EP_DEC=$((10#$RAWEp))

                mkdir -p "strm/TV Shows/$SHOW/Season $SEASON_DEC" || true

                OUT="strm/TV Shows/$SHOW/Season $SEASON_DEC/$SHOW S$(printf "%02d" $SEASON_DEC)E$(printf "%02d" $EP_DEC).strm"
                echo "$LINK" > "$OUT" || true

                echo "Created TV STRM: $OUT"
                continue
              fi

              #
              # MOVIES — always fallback safe
              #
              TITLE=$(echo "$BASENAME" | sed -E 's/\.[0-9]{4}\..*//; s/[._]/ /g' || true)
              YEAR=$(echo "$BASENAME" | grep -oE '[0-9]{4}' || echo "")

              OUT="strm/Movies/$TITLE ($YEAR).strm"
              echo "$LINK" > "$OUT" || true

              echo "Created Movie STRM: $OUT"

            done

          done

      - name: Upload to Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: strm

  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
      - uses: actions/deploy-pages@v4
