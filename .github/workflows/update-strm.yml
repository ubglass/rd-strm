name: RD STRM Builder

on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build STRM Library
        run: |
          set -e

          TMDB="${{ secrets.TMDB_API_KEY }}"
          RDTOKEN="${{ secrets.RDTOKEN }}"

          echo "Preparing site_root..."
          rm -rf site_root
          mkdir -p site_root/Movies
          mkdir -p site_root/TV_Shows

          echo "theme: null" > site_root/_config.yml
          printf "<h1>RD STRM Library</h1>\n<ul><li><a href='Movies/'>Movies</a></li><li><a href='TV_Shows/'>TV Shows</a></li></ul>" \
            > site_root/index.html

          echo "Fetching torrents and downloads..."
          curl -s -H "Authorization: Bearer $RDTOKEN" \
            "https://api.real-debrid.com/rest/1.0/torrents" > torrents.json

          curl -s -H "Authorization: Bearer $RDTOKEN" \
            "https://api.real-debrid.com/rest/1.0/downloads" > downloads.json

          clean_url() {
            echo "$1" | tr -d '"' | tr -d "'" | sed 's/[[:space:]]*$//'
          }

          CUTOFF=$(date -d "15 days ago" +%s)

          jq -c '.[]?' torrents.json | while read TOR; do

            ID=$(echo "$TOR" | jq -r '.id')
            ADDED=$(echo "$TOR" | jq -r '.added // ""')

            # Safe date parsing
            if [[ "$ADDED" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2} ]]; then
              ADDED_EPOCH=$(date -d "$ADDED" +%s)
            else
              ADDED_EPOCH=0
            fi

            [ "$ADDED_EPOCH" -lt "$CUTOFF" ] && continue

            echo "Processing torrent: $ID"

            curl -s -H "Authorization: Bearer $RDTOKEN" \
              "https://api.real-debrid.com/rest/1.0/torrents/info/$ID" \
              > detail.json

            COUNT=$(jq '.files | length' detail.json)

            for i in $(seq 0 $((COUNT - 1))); do

              FILEPATH=$(jq -r ".files[$i].path" detail.json)
              BASENAME=$(basename "$FILEPATH")
              EXT="${BASENAME##*.}"

              [[ ! "$EXT" =~ ^(mkv|mp4|avi|mov|webm)$ ]] && continue

              ###########################################################################
              # ------------------------------ TV SHOW LOGIC ----------------------------
              ###########################################################################
              if [[ "$BASENAME" =~ [Ss][0-9]{2}[Ee][0-9]{2} ]]; then

                RAW=$(echo "$BASENAME" | sed -E 's/\.[Ss][0-9]+.*//' | tr '._' ' ' | sed 's/  */ /g')
                YEAR=$(echo "$BASENAME" | grep -oE '(19[0-9]{2}|20[0-3][0-9])')

                # Folder name
                if [[ -n "$YEAR" ]]; then
                  SHOWDIR="site_root/TV_Shows/${RAW} (${YEAR})"
                else
                  SHOWDIR="site_root/TV_Shows/${RAW}"
                fi
                mkdir -p "$SHOWDIR"

                # Extract episode numbers
                SNUM=$(echo "$BASENAME" | grep -oE 'S[0-9]{2}' | tr -d 'S')
                ENUM=$(echo "$BASENAME" | grep -oE 'E[0-9]{2}' | tr -d 'E')

                SNUM=$((10#$SNUM))
                ENUM=$((10#$ENUM))

                SXX=$(printf "%02d" "$SNUM")
                EXX=$(printf "%02d" "$ENUM")

                #######################################################################
                # EXACT STREAM MAPPING VIA RD LINK MATCHING (PERFECT MATCH)
                #######################################################################
                TORRENT_LINK=$(jq -r ".links[$i]" detail.json)

                DIRECT=$(jq -r \
                  --arg L "$TORRENT_LINK" \
                  '.[] | select(.link == $L and .streamable == 1) | .download' \
                  downloads.json
                )

                # fallback if not found (fresh torrent)
                if [[ -z "$DIRECT" || "$DIRECT" == "null" ]]; then
                  UNR=$(curl -s -X POST \
                    -H "Authorization: Bearer $RDTOKEN" \
                    -d "link=$TORRENT_LINK" \
                    "https://api.real-debrid.com/rest/1.0/unrestrict/link")
                  DIRECT=$(echo "$UNR" | jq -r '.download')
                fi

                [[ -z "$DIRECT" || "$DIRECT" == "null" ]] && continue

                DIRECT=$(clean_url "$DIRECT")

                # Create tvshow.nfo only once
                if [[ ! -f "$SHOWDIR/.tmdb_id" ]]; then
                  SEARCH=$(curl -s \
                    "https://api.themoviedb.org/3/search/tv?api_key=$TMDB&query=$RAW")
                  SID=$(echo "$SEARCH" | jq -r '.results[0].id')
                  echo "$SID" > "$SHOWDIR/.tmdb_id"

                  SHOWJSON=$(curl -s \
                    "https://api.themoviedb.org/3/tv/$SID?api_key=$TMDB")

                  SHOWPLOT=$(echo "$SHOWJSON" | jq -r '.overview // ""')
                  RUNTIME=$(echo "$SHOWJSON" | jq -r '.episode_run_time[0] // 0')

                  printf "<tvshow>\n<title>%s</title>\n<plot>%s</plot>\n<runtime>%s</runtime>\n</tvshow>" \
                    "$RAW" "$SHOWPLOT" "$RUNTIME" > "$SHOWDIR/tvshow.nfo"
                fi

                SID=$(cat "$SHOWDIR/.tmdb_id")

                SEASON_DIR="$SHOWDIR/Season $SXX"
                mkdir -p "$SEASON_DIR"

                #######################################################################
                # Write episode STRM file
                #######################################################################
                STRM="$SEASON_DIR/${RAW} S${SXX}E${EXX}.strm"
                printf "%s" "$DIRECT" > "$STRM"

                #######################################################################
                # Episode Metadata (with EPISODE NAME)
                #######################################################################
                EPJSON=$(curl -s \
                  "https://api.themoviedb.org/3/tv/$SID/season/$SNUM/episode/$ENUM?api_key=$TMDB")

                EPLOT=$(echo "$EPJSON" | jq -r '.overview // ""')
                EDATE=$(echo "$EPJSON" | jq -r '.air_date // ""')
                EPNAME=$(echo "$EPJSON" | jq -r '.name // ""')

                printf "<episodedetails>\n<title>%s</title>\n<episodename>%s</episodename>\n<season>%s</season>\n<episode>%s</episode>\n<aired>%s</aired>\n<plot>%s</plot>\n</episodedetails>" \
                  "$RAW" "$EPNAME" "$SNUM" "$ENUM" "$EDATE" "$EPLOT" \
                  > "$SEASON_DIR/${RAW} S${SXX}E${EXX}.nfo"

                continue
              fi

              ###########################################################################
              # ------------------------------ MOVIE LOGIC ------------------------------
              ###########################################################################
              RAW2=$(echo "$BASENAME" | tr '._' ' ')
              YEAR=$(echo "$RAW2" | grep -oE '(19[0-9]{2}|20[0-3][0-9])')
              TITLE=$(echo "$RAW2" | sed -E "s/$YEAR.*//" | sed 's/  */ /g')

              # RD link for this movie file
              TORRENT_LINK=$(jq -r ".links[$i]" detail.json)

              DIRECT=$(jq -r \
                --arg L "$TORRENT_LINK" \
                '.[] | select(.link == $L and .streamable == 1) | .download' \
                downloads.json
              )

              if [[ -z "$DIRECT" || "$DIRECT" == "null" ]]; then
                UNR=$(curl -s -X POST \
                  -H "Authorization: Bearer $RDTOKEN" \
                  -d "link=$TORRENT_LINK" \
                  "https://api.real-debrid.com/rest/1.0/unrestrict/link")
                DIRECT=$(echo "$UNR" | jq -r '.download')
              fi

              [[ -z "$DIRECT" || "$DIRECT" == "null" ]] && continue

              DIRECT=$(clean_url "$DIRECT")

              MOVIEDIR="site_root/Movies/${TITLE} (${YEAR})"
              mkdir -p "$MOVIEDIR"

              printf "%s" "$DIRECT" > "$MOVIEDIR/${TITLE} (${YEAR}).strm"

            done
          done

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site_root

      - name: Deploy
        uses: actions/deploy-pages@v4
