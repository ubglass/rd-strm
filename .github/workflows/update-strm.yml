name: RD STRM Builder (Remote Artwork)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Prepare workspace
        run: |
          rm -rf site_root
          mkdir -p site_root/Movies
          mkdir -p site_root/TV_Shows

      - name: Fetch Real-Debrid downloads
        id: rd
        run: |
          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
            "https://api.real-debrid.com/rest/1.0/downloads" \
            | jq '.' > rd.json

          echo "[INFO] RD downloads fetched"

      - name: Build STRM & NFO – Movies
        run: |
          mkdir -p site_root/Movies

          jq -c '.[]' rd.json | while read DL; do
            FILENAME=$(echo "$DL" | jq -r '.filename')
            LINK=$(echo "$DL" | jq -r '.download')
            GEN=$(echo "$DL" | jq -r '.generated')

            # Extract movie name + year
            NAME=$(echo "$FILENAME" | sed -E 's/\.[^.]+$//' | sed -E 's/[0-9]{3,4}p.*//')
            YEAR=$(echo "$FILENAME" | grep -oE '(19|20)[0-9]{2}' | head -1)

            [ -z "$YEAR" ] && continue

            # TMDB SEARCH
            TRES=$(curl -s "https://api.themoviedb.org/3/search/movie?api_key=${{ secrets.TMDB_API_KEY }}&query=$(jq -rn --arg v "$NAME" '$v|@uri')&year=$YEAR")
            MID=$(echo "$TRES" | jq -r '.results[0].id // empty')

            [ -z "$MID" ] && continue

            # TMDB DETAILS
            MDET=$(curl -s "https://api.themoviedb.org/3/movie/$MID?api_key=${{ secrets.TMDB_API_KEY }}")
            PLOT=$(echo "$MDET" | jq -r '.overview // ""')
            RUNTIME=$(echo "$MDET" | jq -r '.runtime // 0')
            POSTER=$(echo "$MDET" | jq -r '.poster_path // empty')
            FANART=$(echo "$MDET" | jq -r '.backdrop_path // empty')
            DATE=$(echo "$MDET" | jq -r '.release_date // ""')

            MD="site_root/Movies/${NAME} (${YEAR})"
            mkdir -p "$MD"

            # STRM file
            echo "$LINK" > "$MD/${NAME} (${YEAR}).strm"

            # REMOTE artwork URLs
            POSTER_URL="https://image.tmdb.org/t/p/w500$POSTER"
            FANART_URL="https://image.tmdb.org/t/p/w500$FANART"              # MOVIE NFO
            printf '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<movie>\n' > "$MD/${NAME} (${YEAR}).nfo"
            printf '  <title>%s</title>\n' "$NAME" >> "$MD/${NAME} (${YEAR}).nfo"
            printf '  <originaltitle>%s</originaltitle>\n' "$NAME" >> "$MD/${NAME} (${YEAR}).nfo"
            printf '  <year>%s</year>\n' "$YEAR" >> "$MD/${NAME} (${YEAR}).nfo"
            printf '  <premiered>%s</premiered>\n' "$DATE" >> "$MD/${NAME} (${YEAR}).nfo"
            printf '  <plot>%s</plot>\n' "$PLOT" >> "$MD/${NAME} (${YEAR}).nfo"
            printf '  <runtime>%s</runtime>\n' "$RUNTIME" >> "$MD/${NAME} (${YEAR}).nfo"
            printf '  <uniqueid type="tmdb" default="true">%s</uniqueid>\n' "$MID" >> "$MD/${NAME} (${YEAR}).nfo"
            printf '  <id>%s</id>\n' "$MID" >> "$MD/${NAME} (${YEAR}).nfo"
            printf '  <thumb>%s</thumb>\n' "$POSTER_URL" >> "$MD/${NAME} (${YEAR}).nfo"
            printf '  <fanart>%s</fanart>\n' "$FANART_URL" >> "$MD/${NAME} (${YEAR}).nfo"
            printf '</movie>\n' >> "$MD/${NAME} (${YEAR}).nfo"
          done

      - name: Build STRM & NFO – TV Shows
        run: |
          jq -c '.[]' rd.json | while read DL; do
            FILENAME=$(echo "$DL" | jq -r '.filename')
            LINK=$(echo "$DL" | jq -r '.download')

            # Detect SXXEYY
            if [[ "$FILENAME" =~ S([0-9]{2})E([0-9]{2}) ]]; then
              S=${BASH_REMATCH[1]}
              E=${BASH_REMATCH[2]}
            else
              continue
            fi

            # Extract show name + year
            SHOWNAME=$(echo "$FILENAME" | sed -E 's/S[0-9]{2}E[0-9]{2}.*//; s/\.[^.]+$//')
            YEAR=$(echo "$FILENAME" | grep -oE '(19|20)[0-9]{2}' | head -1)

            [ -z "$YEAR" ] && continue

            # TMDB TV SEARCH
            TRES=$(curl -s "https://api.themoviedb.org/3/search/tv?api_key=${{ secrets.TMDB_API_KEY }}&query=$(jq -rn --arg v "$SHOWNAME" '$v|@uri')&first_air_date_year=$YEAR")
            SID=$(echo "$TRES" | jq -r '.results[0].id // empty')

            [ -z "$SID" ] && continue

            # TMDB SHOW DETAILS
            SDET=$(curl -s "https://api.themoviedb.org/3/tv/$SID?api_key=${{ secrets.TMDB_API_KEY }}")
            SPLOT=$(echo "$SDET" | jq -r '.overview // ""')
            SPOST=$(echo "$SDET" | jq -r '.poster_path // empty')
            SFAN=$(echo "$SDET" | jq -r '.backdrop_path // empty')
            SPREM=$(echo "$SDET" | jq -r '.first_air_date // ""')

            SHOW_DIR="site_root/TV_Shows/${SHOWNAME} (${YEAR})"
            mkdir -p "$SHOW_DIR"

            # SHOW NFO (root)
            if [ ! -f "$SHOW_DIR/${SHOWNAME} (${YEAR}).nfo" ]; then
              printf '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<tvshow>\n' > "$SHOW_DIR/${SHOWNAME} (${YEAR}).nfo"
              printf '  <title>%s</title>\n' "$SHOWNAME" >> "$SHOW_DIR/${SHOWNAME} (${YEAR}).nfo"
              printf '  <year>%s</year>\n' "$YEAR" >> "$SHOW_DIR/${SHOWNAME} (${YEAR}).nfo"
              printf '  <premiered>%s</premiered>\n' "$SPREM" >> "$SHOW_DIR/${SHOWNAME} (${YEAR}).nfo"
              printf '  <plot>%s</plot>\n' "$SPLOT" >> "$SHOW_DIR/${SHOWNAME} (${YEAR}).nfo"
              printf '  <uniqueid type="tmdb" default="true">%s</uniqueid>\n' "$SID" >> "$SHOW_DIR/${SHOWNAME} (${YEAR}).nfo"
              printf '  <id>%s</id>\n' "$SID" >> "$SHOW_DIR/${SHOWNAME} (${YEAR}).nfo"
              printf '  <thumb>https://image.tmdb.org/t/p/w500%s</thumb>\n' "$SPOST" >> "$SHOW_DIR/${SHOWNAME} (${YEAR}).nfo"
              printf '  <fanart>https://image.tmdb.org/t/p/w500%s</fanart>\n' "$SFAN" >> "$SHOW_DIR/${SHOWNAME} (${YEAR}).nfo"
              printf '</tvshow>\n' >> "$SHOW_DIR/${SHOWNAME} (${YEAR}).nfo"
            fi

            # EPISODE DETAILS
            EDET=$(curl -s "https://api.themoviedb.org/3/tv/$SID/season/$((10#$S))/episode/$((10#$E))?api_key=${{ secrets.TMDB_API_KEY }}")
            EP_TITLE=$(echo "$EDET" | jq -r '.name // ""')
            EP_PLOT=$(echo "$EDET" | jq -r '.overview // ""')
            EP_DATE=$(echo "$EDET" | jq -r '.air_date // ""')
            EP_RT=$(echo "$EDET" | jq -r '.runtime // 0')
            EP_ID=$(echo "$EDET" | jq -r '.id // empty')
            EP_STILL=$(echo "$EDET" | jq -r '.still_path // empty')

            EP_STILL_URL="https://image.tmdb.org/t/p/w500${EP_STILL}"

            SEASON_DIR="$SHOW_DIR/Season $((10#$S))"
            mkdir -p "$SEASON_DIR"

            BASE="${SHOWNAME} (${YEAR}) - S${S}E${E}"

            echo "$LINK" > "$SEASON_DIR/${BASE}.strm"

            # EPISODE NFO
            printf '<?xml version="1.0" encoding="UTF-8" standalone="yes"?>\n<episodedetails>\n' > "$SEASON_DIR/${BASE}.nfo"
            printf '  <title>%s</title>\n' "$EP_TITLE" >> "$SEASON_DIR/${BASE}.nfo"
            printf '  <season>%s</season>\n' "$((10#$S))" >> "$SEASON_DIR/${BASE}.nfo"
            printf '  <episode>%s</episode>\n' "$((10#$E))" >> "$SEASON_DIR/${BASE}.nfo"
            printf '  <aired>%s</aired>\n' "$EP_DATE" >> "$SEASON_DIR/${BASE}.nfo"
            printf '  <plot>%s</plot>\n' "$EP_PLOT" >> "$SEASON_DIR/${BASE}.nfo"
            printf '  <runtime>%s</runtime>\n' "$EP_RT" >> "$SEASON_DIR/${BASE}.nfo"
            printf '  <uniqueid type="tmdb" default="true">%s</uniqueid>\n' "$EP_ID" >> "$SEASON_DIR/${BASE}.nfo"
            printf '  <id>%s</id>\n' "$EP_ID" >> "$SEASON_DIR/${BASE}.nfo"
            printf '  <thumb>%s</thumb>\n' "$EP_STILL_URL" >> "$SEASON_DIR/${BASE}.nfo"
            printf '</episodedetails>\n' >> "$SEASON_DIR/${BASE}.nfo"
          done

      - name: Cleanup Koofr
        run: |
          echo "Cleaning remote storage…"

          # local file list
          find site_root -type f | sed 's#site_root/##' > local.txt

          # remote file list
          curl -s -X PROPFIND \
            -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
            "${{ secrets.KOFR_URL }}" \
            | grep -oP '(?<=<d:href>).*?(?=</d:href>)' \
            | sed 's/%20/ /g' \
            | sed "s#${{ secrets.KOFR_URL }}##" > remote.txt

          while read RF; do
            [ -z "$RF" ] && continue
            if ! grep -Fxq "$RF" local.txt; then
              echo "Deleting stale file: $RF"
              ENC=$(printf '%s' "$RF" | sed 's/ /%20/g')
              curl -s -X DELETE -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
                "${{ secrets.KOFR_URL }}$ENC" >/dev/null
            fi
          done < remote.txt

      - name: Upload new files to Koofr
        run: |
          find site_root -type f | while read FILE; do
            REL=$(echo "$FILE" | sed 's#site_root/##')
            ENC_REL=$(printf '%s' "$REL" | sed 's/ /%20/g')
            DEST="${{ secrets.KOFR_URL }}$ENC_REL"
            
            echo "Uploading $REL -> $DEST"
            RESPONSE=$(curl -s -w "%{http_code}" -T "$FILE" -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" "$DEST")
            HTTP_CODE="${RESPONSE: -3}"
            
            if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
              echo "✅ Uploaded $REL (HTTP $HTTP_CODE)"
            else
              echo "❌ Failed $REL (HTTP $HTTP_CODE)"
              echo "Response: ${RESPONSE%???}"
            fi
          done
