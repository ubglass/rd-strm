- name: Build STRM library
  run: |
    set +e
    TMDB="${{ secrets.TMDB_API_KEY }}"
    CUTOFF=$(date -d "15 days ago" +%s)

    clean_url() {
      echo "$1" | tr -d '"' | tr -d "'" | sed 's/[[:space:]]*$//'
    }

    jq -c '.[]?' downloads.json | while read DL; do

      GEN=$(echo "$DL" | jq -r '.generated')
      [ "$GEN" -lt "$CUTOFF" ] && continue

      FILE=$(echo "$DL" | jq -r '.filename')
      LINK=$(echo "$DL" | jq -r '.download')
      STREAM=$(echo "$DL" | jq -r '.streamable')

      [ "$STREAM" != "1" ] && continue

      BASENAME=$(basename "$FILE")
      CLEANNAME=$(echo "$BASENAME" | sed 's/\?.*//')

      EXT="${CLEANNAME##*.}"
      [[ ! "$EXT" =~ ^(mkv|mp4|avi|mov|webm)$ ]] && continue

      # ----------------------------
      # TV SHOW DETECTION
      # ----------------------------
      if [[ "$CLEANNAME" =~ [Ss][0-9][0-9][Ee][0-9][0-9] ]]; then

        RAW=$(echo "$CLEANNAME" | sed -E 's/\.[Ss][0-9]+.*//' | sed 's/[._]/ /g' | sed 's/  */ /g')
        YEAR=$(echo "$CLEANNAME" | grep -oE '(19[0-9]{2}|20[0-3][0-9])')

        if [ -n "$YEAR" ]; then
          SHOWDIR="site_root/TV_Shows/${RAW} (${YEAR})"
        else
          SHOWDIR="site_root/TV_Shows/${RAW}"
        fi

        mkdir -p "$SHOWDIR"

        # Create tvshow.nfo once
        if [ ! -f "$SHOWDIR/.tmdb_id" ]; then
          SEARCH=$(curl -s "https://api.themoviedb.org/3/search/tv?api_key=$TMDB&query=$RAW")
          SID=$(echo "$SEARCH" | jq -r '.results[0].id')
          echo "$SID" > "$SHOWDIR/.tmdb_id"

          DETAIL=$(curl -s "https://api.themoviedb.org/3/tv/$SID?api_key=$TMDB")
          PLOT=$(echo "$DETAIL" | jq -r '.overview // ""')
          RUNTIME=$(echo "$DETAIL" | jq -r '.episode_run_time[0] // 0')

          printf "<tvshow>\n<title>%s</title>\n<plot>%s</plot>\n<runtime>%s</runtime>\n</tvshow>" \
            "$RAW" "$PLOT" "$RUNTIME" > "$SHOWDIR/tvshow.nfo"
        fi

        SID=$(cat "$SHOWDIR/.tmdb_id")

        SNUM=$(echo "$CLEANNAME" | grep -oE 'S[0-9]+' | tr -d 'S')
        ENUM=$(echo "$CLEANNAME" | grep -oE 'E[0-9]+' | tr -d 'E')

        SNUM=$((10#$SNUM))
        ENUM=$((10#$ENUM))

        SEASON_DIR="$SHOWDIR/Season $(printf '%02d' $SNUM)"
        mkdir -p "$SEASON_DIR"

        STRM="$SEASON_DIR/${RAW} S$(printf '%02d' $SNUM)E$(printf '%02d' $ENUM).strm"
        printf "%s" "$LINK" > "$STRM"

        EPJSON=$(curl -s "https://api.themoviedb.org/3/tv/$SID/season/$SNUM/episode/$ENUM?api_key=$TMDB")
        EPLOT=$(echo "$EPJSON" | jq -r '.overview // ""')
        EDATE=$(echo "$EPJSON" | jq -r '.air_date // ""')

        printf "<episodedetails>\n<title>%s</title>\n<season>%s</season>\n<episode>%s</episode>\n<aired>%s</aired>\n<plot>%s</plot>\n</episodedetails>" \
          "$RAW" "$SNUM" "$ENUM" "$EDATE" "$EPLOT" \
          > "$SEASON_DIR/${RAW} S$(printf '%02d' $SNUM)E$(printf '%02d' $ENUM).nfo"

        continue
      fi

      # ----------------------------
      # MOVIES
      # ----------------------------
      RAW2=$(echo "$CLEANNAME" | sed -E 's/[._]/ /g')
      YEAR=$(echo "$RAW2" | grep -oE '(19[0-9]{2}|20[0-3][0-9])')
      TITLE=$(echo "$RAW2" | sed -E "s/$YEAR.*//" | sed 's/  */ /g')

      MOVIEDIR="site_root/Movies/${TITLE} (${YEAR})"
      mkdir -p "$MOVIEDIR"

      printf "%s" "$LINK" > "$MOVIEDIR/${TITLE} (${YEAR}).strm"

      MSEARCH=$(curl -s "https://api.themoviedb.org/3/search/movie?api_key=$TMDB&query=$TITLE")
      MID=$(echo "$MSEARCH" | jq -r '.results[0].id')

      MDET=$(curl -s "https://api.themoviedb.org/3/movie/$MID?api_key=$TMDB")
      MPLOT=$(echo "$MDET" | jq -r '.overview // ""')
      MRUN=$(echo "$MDET" | jq -r '.runtime // 0')

      printf "<movie>\n<title>%s</title>\n<year>%s</year>\n<runtime>%s</runtime>\n<plot>%s</plot>\n</movie>" \
        "$TITLE" "$YEAR" "$MRUN" "$MPLOT" \
        > "$MOVIEDIR/movie.nfo"

    done
