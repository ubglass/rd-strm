name: RD STRM Builder (Remote Artwork)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Prepare workspace
        run: |
          rm -rf site_root
          mkdir -p site_root/Movies
          mkdir -p site_root/TV_Shows

      - name: Fetch Real-Debrid downloads
        id: rd
        run: |
          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
            "https://api.real-debrid.com/rest/1.0/downloads" \
            | jq '.' > rd.json

          echo "[INFO] RD downloads fetched"

      - name: Build STRM & NFO – Movies
        run: |
          mkdir -p site_root/Movies

          jq -c '.[]' rd.json | while read DL; do
            FILENAME=$(echo "$DL" | jq -r '.filename')
            LINK=$(echo "$DL" | jq -r '.download')
            GEN=$(echo "$DL" | jq -r '.generated')

            # Extract movie name + year
            NAME=$(echo "$FILENAME" | sed -E 's/\.[^.]+$//' | sed -E 's/[0-9]{3,4}p.*//')
            YEAR=$(echo "$FILENAME" | grep -oE '(19|20)[0-9]{2}' | head -1)

            [ -z "$YEAR" ] && continue

            # TMDB SEARCH
            TRES=$(curl -s "https://api.themoviedb.org/3/search/movie?api_key=${{ secrets.TMDB_API_KEY }}&query=$(jq -rn --arg v "$NAME" '$v|@uri')&year=$YEAR")
            MID=$(echo "$TRES" | jq -r '.results[0].id // empty')

            [ -z "$MID" ] && continue

            # TMDB DETAILS
            MDET=$(curl -s "https://api.themoviedb.org/3/movie/$MID?api_key=${{ secrets.TMDB_API_KEY }}")
            PLOT=$(echo "$MDET" | jq -r '.overview // ""')
            RUNTIME=$(echo "$MDET" | jq -r '.runtime // 0')
            POSTER=$(echo "$MDET" | jq -r '.poster_path // empty')
            FANART=$(echo "$MDET" | jq -r '.backdrop_path // empty')
            DATE=$(echo "$MDET" | jq -r '.release_date // ""')

            MD="site_root/Movies/${NAME} (${YEAR})"
            mkdir -p "$MD"

            # STRM file
            echo "$LINK" > "$MD/${NAME} (${YEAR}).strm"

            # REMOTE artwork URLs
            POSTER_URL="https://image.tmdb.org/t/p/w500$POSTER"
            FANART_URL="https://image.tmdb.org/t/p/w500$FANART"

            cat > "$MD/${NAME} (${YEAR}).nfo" <<EOF
<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<movie>
<title>${NAME}</title>
<originaltitle>${NAME}</originaltitle>
<year>${YEAR}</year>
<premiered>${DATE}</premiered>
<plot>${PLOT}</plot>
<runtime>${RUNTIME}</runtime>
<uniqueid type="tmdb" default="true">${MID}</uniqueid>
<id>${MID}</id>
<thumb>${POSTER_URL}</thumb>
<fanart>${FANART_URL}</fanart>
</movie>
EOF
          done

      - name: Build STRM & NFO – TV Shows
        run: |
          jq -c '.[]' rd.json | while read DL; do
            FILENAME=$(echo "$DL" | jq -r '.filename')
            LINK=$(echo "$DL" | jq -r '.download')

            # Detect SXXEYY
            if [[ "$FILENAME" =~ S([0-9]{2})E([0-9]{2}) ]]; then
              S=${BASH_REMATCH[1]}
              E=${BASH_REMATCH[2]}
            else
              continue
            fi

            # Extract show name + year
            SHOWNAME=$(echo "$FILENAME" | sed -E 's/S[0-9]{2}E[0-9]{2}.*//; s/\.[^.]+$//')
            YEAR=$(echo "$FILENAME" | grep -oE '(19|20)[0-9]{2}' | head -1)

            [ -z "$YEAR" ] && continue

            # TMDB TV SEARCH
            TRES=$(curl -s "https://api.themoviedb.org/3/search/tv?api_key=${{ secrets.TMDB_API_KEY }}&query=$(jq -rn --arg v "$SHOWNAME" '$v|@uri')&first_air_date_year=$YEAR")
            SID=$(echo "$TRES" | jq -r '.results[0].id // empty')

            [ -z "$SID" ] && continue

            # TMDB SHOW DETAILS
            SDET=$(curl -s "https://api.themoviedb.org/3/tv/$SID?api_key=${{ secrets.TMDB_API_KEY }}")
            SPLOT=$(echo "$SDET" | jq -r '.overview // ""')
            SPOST=$(echo "$SDET" | jq -r '.poster_path // empty')
            SFAN=$(echo "$SDET" | jq -r '.backdrop_path // empty')
            SPREM=$(echo "$SDET" | jq -r '.first_air_date // ""')

            SHOW_DIR="site_root/TV_Shows/${SHOWNAME} (${YEAR})"
            mkdir -p "$SHOW_DIR"

            # SHOW NFO (root)
            if [ ! -f "$SHOW_DIR/tvshow.nfo" ]; then
              cat > "$SHOW_DIR/tvshow.nfo" <<EOF
              <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
              <tvshow>
                <title>${SHOWNAME}</title>
                <year>${YEAR}</year>
                <premiered>${SPREM}</premiered>
                <plot>${SPLOT}</plot>
                <uniqueid type="tmdb" default="true">${SID}</uniqueid>
                <id>${SID}</id>
                <thumb>https://image.tmdb.org/t/p/w500${SPOST}</thumb>
                <fanart>https://image.tmdb.org/t/p/w500${SFAN}</fanart>
              </tvshow>
              EOF
            fi

            # EPISODE DETAILS
            EDET=$(curl -s "https://api.themoviedb.org/3/tv/$SID/season/$((10#$S))/episode/$((10#$E))?api_key=${{ secrets.TMDB_API_KEY }}")
            EP_TITLE=$(echo "$EDET" | jq -r '.name // ""')
            EP_PLOT=$(echo "$EDET" | jq -r '.overview // ""')
            EP_DATE=$(echo "$EDET" | jq -r '.air_date // ""')
            EP_RT=$(echo "$EDET" | jq -r '.runtime // 0')
            EP_ID=$(echo "$EDET" | jq -r '.id // empty')
            EP_STILL=$(echo "$EDET" | jq -r '.still_path // empty')

            EP_STILL_URL="https://image.tmdb.org/t/p/w500${EP_STILL}"

            SEASON_DIR="$SHOW_DIR/Season $((10#$S))"
            mkdir -p "$SEASON_DIR"

            BASE="${SHOWNAME} (${YEAR}) - S${S}E${E}"

            echo "$LINK" > "$SEASON_DIR/${BASE}.strm"

            # EPISODE NFO
            cat > "$SEASON_DIR/${BASE}.nfo" <<EOF
            <?xml version="1.0" encoding="UTF-8" standalone="yes"?>
            <episodedetails>
              <title>${EP_TITLE}</title>
              <season>$((10#$S))</season>
              <episode>$((10#$E))</episode>
              <aired>${EP_DATE}</aired>
              <plot>${EP_PLOT}</plot>
              <runtime>${EP_RT}</runtime>
              <uniqueid type="tmdb" default="true">${EP_ID}</uniqueid>
              <id>${EP_ID}</id>
              <thumb>${EP_STILL_URL}</thumb>
            </episodedetails>
            EOF
          done

      - name: Cleanup Koofr
        run: |
          echo "Cleaning remote storage…"

          # local file list
          find site_root -type f | sed 's#site_root/##' > local.txt

          # remote file list
          curl -s -X PROPFIND \
            -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
            "${{ secrets.KOFR_URL }}" \
            | grep -oP '(?<=<d:href>).*?(?=</d:href>)' \
            | sed 's/%20/ /g' \
            | sed "s#${{ secrets.KOFR_URL }}##" > remote.txt

          while read RF; do
            [ -z "$RF" ] && continue
            if ! grep -Fxq "$RF" local.txt; then
              echo "Deleting stale file: $RF"
              ENC=$(printf '%s' "$RF" | sed 's/ /%20/g')
              curl -s -X DELETE -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" \
                "${{ secrets.KOFR_URL }}$ENC" >/dev/null
            fi
          done < remote.txt

      - name: Upload new files to Koofr
        run: |
          find site_root -type f | while read FILE; do
            REL=$(echo "$FILE" | sed 's#site_root/##')
            DEST="${{ secrets.KOFR_URL }}$(printf '%s' "$REL" | sed 's/ /%20/g')"
            echo "Uploading $REL"
            curl -s -T "$FILE" -u "${{ secrets.KOFR_USER }}:${{ secrets.KOFR_PASS }}" "$DEST"
          done
