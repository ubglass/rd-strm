name: RD STRM Builder (GitHub Pages Deployment)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # Run every hour

permissions:
  contents: read
  pages: write
  id-token: write

jobs:

  build:
    runs-on: ubuntu-latest
    steps:

      ###############################################################
      # CHECKOUT REPO
      ###############################################################
      - name: Checkout repo
        uses: actions/checkout@v4

      ###############################################################
      # CLEAN OUTPUT FOLDER
      ###############################################################
      - name: Prepare output
        run: |
          rm -rf site_root
          mkdir -p site_root/Movies
          mkdir -p site_root/TV_Shows

      ###############################################################
      # DISABLE JEKYLL
      ###############################################################
      - name: Add config
        run: |
          echo "theme: null" > site_root/_config.yml
          echo "markdown: kramdown" >> site_root/_config.yml

      ###############################################################
      # ROOT INDEX
      ###############################################################
      - name: Add root index
        run: |
          echo "<h1>RD STRM Library</h1>" > site_root/index.html
          echo "<ul>" >> site_root/index.html
          echo "<li><a href='Movies/'>Movies</a></li>" >> site_root/index.html
          echo "<li><a href='TV_Shows/'>TV Shows</a></li>" >> site_root/index.html
          echo "</ul>" >> site_root/index.html

      ###############################################################
      # FETCH RD TORRENTS
      ###############################################################
      - name: Fetch RD torrents
        run: |
          curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
            "https://api.real-debrid.com/rest/1.0/torrents" > torrents.json

      ###############################################################
      # BUILD STRM FILES
      ###############################################################
      - name: Build STRM files
        run: |
          set +e
          CUTOFF=$(date -d "15 days ago" +%s)

          jq -c '.[]?' torrents.json | while read TOR; do
            ID=$(echo "$TOR" | jq -r '.id')
            NAME=$(echo "$TOR" | jq -r '.filename')
            ADDED=$(echo "$TOR" | jq -r '.added')
            [ -z "$ID" ] && continue
            ADDED_EPOCH=$(date -d "$ADDED" +%s 2>/dev/null || echo 0)
            [ "$ADDED_EPOCH" -lt "$CUTOFF" ] && continue

            curl -s -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
              "https://api.real-debrid.com/rest/1.0/torrents/info/$ID" > detail.json

            COUNT=$(jq '.files | length' detail.json)
            [ "$COUNT" -lt 1 ] && continue

            for i in $(seq 0 $(($COUNT - 1))); do
              FILE=$(jq -r ".files[$i].path" detail.json)
              LINK=$(jq -r ".links[$i]?" detail.json)
              BASENAME=$(basename "$FILE")
              EXT="${BASENAME##*.}"

              [[ ! "$EXT" =~ ^(mkv|mp4|avi|mov|webm)$ ]] && continue
              [ "$LINK" = "null" ] && continue

              UNR=$(curl -s -X POST \
                   -H "Authorization: Bearer ${{ secrets.RDTOKEN }}" \
                   -d "link=$LINK" \
                   "https://api.real-debrid.com/rest/1.0/unrestrict/link")

              DIRECT=$(echo "$UNR" | jq -r '.download')
              [ "$DIRECT" = "null" ] && continue

              ###############################################################
              # TV SHOW LOGIC
              ###############################################################
              if [[ "$BASENAME" =~ [Ss][0-9][0-9][Ee][0-9][0-9] ]]; then
                SHOW=$(echo "$BASENAME" | sed -E 's/\.[Ss][0-9]+.*//; s/[._]/ /g')
                SNUM=$(echo "$BASENAME" | grep -oE '[Ss][0-9]+' | tr -d 'Ss')
                ENUM=$(echo "$BASENAME" | grep -oE '[Ee][0-9]+' | tr -d 'Ee')
                SNUM=$((10#$SNUM))
                ENUM=$((10#$ENUM))

                mkdir -p "site_root/TV_Shows/$SHOW/Season $SNUM"
                echo "$DIRECT" > "site_root/TV_Shows/$SHOW/Season $SNUM/$SHOW S$(printf '%02d' $SNUM)E$(printf '%02d' $ENUM).strm"
                continue
              fi

              ###############################################################
              # MOVIE LOGIC
              ###############################################################
              TITLE=$(echo "$BASENAME" | sed -E 's/[._]/ /g')
              YEAR=$(echo "$BASENAME" | grep -oE '\b(19[0-9]{2}|20[0-3][0-9])\b' | head -n1)
              CLEAN_TITLE=$(echo "$TITLE" | sed -E 's/\b(19[0-9]{2}|20[0-3][0-9])\b.*//')

              MOVIEDIR="site_root/Movies/$CLEAN_TITLE ($YEAR)"
              mkdir -p "$MOVIEDIR"

              OUT="$CLEAN_TITLE ($YEAR).strm"
              echo "$DIRECT" > "$MOVIEDIR/$OUT"
            done
          done

      ###############################################################
      # BUILD HTML INDEXES
      ###############################################################
      - name: Build directory indexes
        run: |
          find site_root -type d | while read DIR; do
            HTML="$DIR/index.html"
            echo "<h2>$(basename "$DIR")</h2><ul>" > "$HTML"

            ls "$DIR" | while read ITEM; do
              if [ -d "$DIR/$ITEM" ]; then
                echo "<li><a href='$ITEM/'>$ITEM/</a></li>" >> "$HTML"
              elif [[ "$ITEM" == *.strm ]]; then
                echo "<li><a href='$ITEM'>$ITEM</a></li>" >> "$HTML"
              fi
            done

            echo "</ul>" >> "$HTML"
          done

      ###############################################################
      # UPLOAD ARTIFACT FOR GITHUB PAGES
      ###############################################################
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site_root

  ###############################################################
  # DEPLOY TO GITHUB PAGES
  ###############################################################
  deploy:
    needs: build
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write

    steps:
      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
